<!DOCTYPE html>
<html lang="zh-cn">
        <head>
      <meta charset="utf-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
      <title>Django中的ORM - JavaChen Blog</title>
      <meta name="author" content="yuke"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
      <link rel="canonical" href="http://blog.javachen.com/2015/01/15/django-orm.html" />

      <link rel="stylesheet" href="/static/contrib/bootstrap/css/bootstrap.min.css" media="all" />
      <link rel="stylesheet" href="/static/css/style.css" media="all" />
      <link rel="stylesheet" href="/static/css/pygments.css" media="all" />
      <link rel="stylesheet" href="/static/contrib/font-awesome/css/font-awesome.min.css" media="all" />
      <link rel="stylesheet" type="text/css" href="/static/contrib/showup/showup.css" />

      <!-- atom & rss feed -->
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="JavaChen Blog RSS Feed" />
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="JavaChen Blog ATOM Feed" />

        <!-- fav and touch icons  -->
        <!-- Update these with your own images
        <link rel="shortcut icon" href="images/favicon.ico">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
        -->

      <meta name="renderer" content="webkit|ie-stand">
      <meta name="baidu-site-verification" content="3HAhaWRiyR" />
      <meta name="360-site-verification" content="9b7a87a1d52051c96644f0a9b8b79898" />
      <meta name="sogou_site_verification" content="ofwXWFdthV"/>
      <meta property="wb:webmaster" content="b6081b2b8ab84c60" />
    </head>

    <body>
      <!--[if lte IE 9]>
<div class="alert alert-warning">
  <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
  <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
</div>
<![endif]-->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">JavaChen Blog</a>
        </div>
        <div class="navbar-collapse collapse">
            <form id="search-form" class="form-group navbar-form navbar-right" role="search">
                  <div class="form-group">
                    <input type="text" name="q" value=""  id="query" class="form-control" placeholder="搜索" required autocomplete="off" ></input>
                    <input type="submit" class="btn btn-default" value=" Go" ></input>
                  </div>
              </form>
            <ul class="nav navbar-nav">
              <li><a href="/archive.html" title="Archive"><span class='fa fa-archive fa-2x'></span></a></li>
              <li><a href="/categories.html" title="Categories"><span class='fa fa-navicon fa-2x'></span></a></li>
              <li><a href="/tags.html" title="Tags"><span class='fa fa-tags fa-2x'></span></a></li>
              <li><a href="/about.html" title="About"><span class='fa fa-user fa-2x'></span></a></li>
              
              <li><a href="https://github.com/javachen" target="_blank" title="Github"><span class='fa fa-github fa-2x'></span></a></li>
              
              
              
              <li><a href="https://twitter.com/java_chen" target="_blank" title="twitter"><span class="fa fa-twitter fa-2x"></span></a></li>
              
              
              
              <li><a href="http://weibo.com/chenzhijun" target="_blank" title="Weibo"><span class="fa fa-weibo fa-2x"></span></a></li>
              
              <li><a href="/rss.xml" target="_blank" title="RSS"><span class='fa fa-rss fa-2x'></span></a></li>
            </ul>
        </div>

        </div><!--/.nav-collapse -->
      </div>
</div>

      <div id="wrap">
          <div class="container">
                 <div id="content">
          <ul class="pager hidden-print">
               
                <li class="previous"><a href="/2015/01/14/django-model.html" title="Django中的模型"><i class="fa fa-angle-double-left"></i>&nbsp;Django中的模型</a></li>
                
                
                <li class="next"><a href="/2015/01/20/maven-skills.html" title="Maven的一些技巧">Maven的一些技巧&nbsp;<i class="fa fa-angle-double-right"></i></a></li>
                
          </ul>

           <div id="post" class="clearfix">
              <div id="post-title" class="page-header text-center">
                  <h1> Django中的ORM  </h1>
              </div>
              <p class="text-muted clearfix">
                  <span class="pull-right">2015.01.15 | <a href="#comments">Comments</a></span>
              </p>
              <div id="qr" class="qrcode visible-lg"></div>

              <div id="post-text">
                    <p>通过《<a href="/2014/01/11/how-to-create-a-django-site.html">如何创建一个Django网站</a>》大概清楚了如何创建一个简单的 Django 网站，并了解了Django 中<a href="/2014/10/30/django-template.html">模板</a>和<a href="/2015/01/14/django-model.html">模型</a>使用方法。本篇文章主要在此基础上，了解 Django 中 ORM 相关的用法。</p>

<p>一个 blog 的应用中 mysite/blog/models.py 有以下实体：</p>

<pre><code class="language-python">from django.db import models

class Blog(models.Model):
    name = models.CharField(max_length=100)
    tagline = models.TextField()

    def __str__(self):              # __unicode__ on Python 2
        return self.name

class Author(models.Model):
    name = models.CharField(max_length=50)
    email = models.EmailField()

    def __str__(self):              # __unicode__ on Python 2
        return self.name

class Entry(models.Model):
    blog = models.ForeignKey(Blog)
    headline = models.CharField(max_length=255)
    body_text = models.TextField()
    pub_date = models.DateField()
    mod_date = models.DateField()
    authors = models.ManyToManyField(Author)
    n_comments = models.IntegerField()
    n_pingbacks = models.IntegerField()
    rating = models.IntegerField()

    def __str__(self):              # __unicode__ on Python 2
        return self.headline
</code></pre>

<h2 id="section">创建对象</h2>

<pre><code class="language-python">&gt;&gt;&gt; from blog.models import Blog
&gt;&gt;&gt; b = Blog(name='Beatles Blog', tagline='All the latest Beatles news.')
&gt;&gt;&gt; b.save()
</code></pre>

<p>你也可以修改实体，然后保存：</p>

<pre><code class="language-python">&gt;&gt;&gt; b5.name = 'New name'
&gt;&gt;&gt; b5.save()    
</code></pre>

<h2 id="section-1">保存外键信息</h2>

<p>下面例子更新 entry 实例的 blog 属性：</p>

<pre><code class="language-python">&gt;&gt;&gt; from blog.models import Entry
&gt;&gt;&gt; entry = Entry.objects.get(pk=1)
&gt;&gt;&gt; cheese_blog = Blog.objects.get(name="Cheddar Talk")
&gt;&gt;&gt; entry.blog = cheese_blog
&gt;&gt;&gt; entry.save()
</code></pre>

<p>下面是更新一个 ManyToManyField 字段：</p>

<pre><code class="language-python">&gt;&gt;&gt; from blog.models import Author
&gt;&gt;&gt; joe = Author.objects.create(name="Joe")
&gt;&gt;&gt; entry.authors.add(joe)
&gt;&gt;&gt; 
&gt;&gt;&gt; john = Author.objects.create(name="John")
&gt;&gt;&gt; paul = Author.objects.create(name="Paul")
&gt;&gt;&gt; george = Author.objects.create(name="George")
&gt;&gt;&gt; ringo = Author.objects.create(name="Ringo")
&gt;&gt;&gt; entry.authors.add(john, paul, george, ringo)
</code></pre>

<h2 id="section-2">查询对象</h2>

<p>Django 中查询数据库需要 Manager 和 QuerySet 两个对象。从数据库里检索对象，可以通过模型的 Manage 来建立 QuerySet,一个 QuerySet 表现为一个数据库中对象的结合，他可以有0个一个或多个过滤条件，在 SQL里 QuerySet 相当于 select 语句用 where 或 limit 过滤。你通过模型的 Manage 来获取 QuerySet。</p>

<h3 id="manager">Manager</h3>

<p>Manager 对象附在模型类里，如果没有特指定，每个模型类都会有一个 objects 属性，它构成了这个模型在数据库所有基本查询。</p>

<p>Manager 的几个常用方法：</p>

<ul>
  <li><code>all</code>：返回一个包含模式里所有数据库记录的 QuerySet</li>
  <li><code>filter</code>：返回一个包含符合指定条件的模型记录的 QuerySet</li>
  <li><code>exclude</code>：和 filter 相反，查找不符合条件的那些记录</li>
  <li><code>get</code>：获取单个符合条件的记录（没有找到或者又超过一个结果都会抛出异常）</li>
  <li><code>order_by</code>：改变 QuerySet 默认的排序</li>
</ul>

<p>你可以通过模型的 Manager 对象获取 QuerySet 对象：</p>

<pre><code class="language-python">&gt;&gt;&gt; Blog.objects
&lt;django.db.models.manager.Manager object at ...&gt;
&gt;&gt;&gt; b = Blog(name='Foo', tagline='Bar')
&gt;&gt;&gt; b.objects
Traceback:
    ...
AttributeError: "Manager isn't accessible via Blog instances."
</code></pre>

<p>获取所有的 blog 内容:</p>

<pre><code class="language-python">&gt;&gt;&gt; all_entries = Entry.objects.all()

#正向排序
Entry.objects.all().order_by("headline")
#反向排序
Entry.objects.all().order_by("-headline")
</code></pre>

<p>获取 headline 为 Python 开头的 blog :</p>

<pre><code class="language-python">Entry.objects.filter(headline__startswith="Python")

#支持链式操作
Entry.objects.filter(headline__startswith="Python").exclude(pub_date__gte=datetime.now()).filter(pub_date__gte=datetime(2014, 1, 1))
</code></pre>

<h3 id="queryset-">QuerySet 类</h3>

<p>QuerySet 接受动态的关键字参数，然后转换成合适的 SQL 语句在数据库上执行。</p>

<p>QuerySet 的几个常用方法：</p>

<ul>
  <li><code>distinct</code></li>
  <li><code>values</code></li>
  <li><code>values_list</code></li>
  <li><code>select_related</code></li>
  <li><code>filter</code>：返回一个包含符合指定条件的模型记录的 QuerySet</li>
  <li><code>extra</code>：增加结果集以外的字段</li>
</ul>

<h4 id="section-3">延时查询</h4>

<p>每次你完成一个 QuerySet，你获得一个全新的结果集，不包括前面的。每次完成的结果集是可以贮存，使用或复用：</p>

<pre><code class="language-python">&gt;&gt;&gt; q1 = Entry.objects.filter(headline__startswith="What")
&gt;&gt;&gt; q2 = q1.exclude(pub_date__gte=datetime.date.today())
&gt;&gt;&gt; q3 = q1.filter(pub_date__gte=datetime.date.today())
</code></pre>

<p>三个 QuerySets 是分开的，第一个是 headline 以 “What” 单词开头的结果集，第二个是第一个的子集，即 pub_date 不大于现在的，第三个是第一个的子集 ，pub_date 大于现在的。</p>

<p>QuerySets 是延迟的，创建 QuerySets 不会触及到数据库操作，你可以多个过滤合并到一起，直到求值的时候 django才会开始查询。如：</p>

<pre><code class="language-python">&gt;&gt;&gt; q = Entry.objects.filter(headline__startswith="What")
&gt;&gt;&gt; q = q.filter(pub_date__lte=datetime.date.today())
&gt;&gt;&gt; q = q.exclude(body_text__icontains="food")
&gt;&gt;&gt; print(q)
</code></pre>

<p>虽然看起来执行了三个过滤条件，实际上最后执行 <code>print q</code> 的时候，django 才开始查询执行 SQL 到数据库。</p>

<p>可以使用 python 的数组限制语法限定 QuerySet，如：</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.all()[:5]
&gt;&gt;&gt; Entry.objects.all()[5:10]

&gt;&gt;&gt; Entry.objects.all().order_by("headline")[:4]
&gt;&gt;&gt; Entry.objects.all().order_by("headline")[4:8]
</code></pre>

<p>一般的，限制 QuerySet 返回新的 QuerySet，不会立即求值查询，除非你使用了 “step” 参数</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.all()[:10:2]
&gt;&gt;&gt; Entry.objects.order_by('headline')[0]
&gt;&gt;&gt; Entry.objects.order_by('headline')[0:1].get()
</code></pre>

<h4 id="section-4">字段过滤</h4>

<p>字段查找是指定 SQL 语句的 WHERE 条件从句，通过 QuerySet 的方法 <code>filter()</code>, <code>exclude()</code> 和 <code>get()</code> 指定查询关键字。</p>

<p>格式为：<code>field__lookuptype=value</code>。</p>

<p>lookuptype 有以下几种：</p>

<ul>
  <li><code>gt</code> ： 大于</li>
  <li><code>gte</code> : 大于等于</li>
  <li><code>in</code> : 包含</li>
  <li><code>lt</code> : 小于</li>
  <li><code>lte</code> : 小于等于</li>
  <li><code>exact</code>：</li>
  <li><code>iexact</code>：</li>
  <li><code>contains</code>：包含查询，区分大小写</li>
  <li><code>icontains</code>：不区分大小写</li>
  <li><code>startswith</code>：匹配开头</li>
  <li><code>endswith</code>：匹配结尾</li>
  <li><code>istartswith</code>：匹配开头，不区分大小写</li>
  <li><code>iendswith</code>：匹配结尾，不区分大小写</li>
</ul>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.filter(pub_date__lte='2006-01-01')
</code></pre>

<p>等价于:</p>

<pre><code class="language-sql">SELECT * FROM blog_entry WHERE pub_date &lt;= '2006-01-01';
</code></pre>

<p>当实体中存在  ForeignKey 时，其外键字段名称为模型名称加上 ‘_id’：</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.filter(blog_id=4)
</code></pre>

<p>下面是一些举例：</p>

<p>a、exact</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.get(headline__exact="Man bites dog")
</code></pre>

<p>相当于：</p>

<pre><code class="language-sql">SELECT ... WHERE headline = 'Man bites dog';
</code></pre>

<p>如果查询没有提供双下划线，那么会默认 <code>__exact</code>:</p>

<pre><code class="language-python">Entry.objects.get(id__exact=14) # Explicit form
Entry.objects.get(id=14) # __exact is implied

#主键查询
Entry.objects.get(pk=14) # pk implies id__exact
</code></pre>

<p>b、iexact——忽略大小写</p>

<pre><code class="language-python">&gt;&gt;&gt; Blog.objects.get(name__iexact="beatles blog")
</code></pre>

<p>将要匹配 blog 名称为 “Beatles Blog”, “beatles blog”, 甚至是 “BeAtlES blOG”。</p>

<p>c、contains——包含查询，区分大小写</p>

<pre><code class="language-python">Entry.objects.get(headline__contains='Lennon')
</code></pre>

<p>转化为 SQL:</p>

<pre><code class="language-sql">SELECT ... WHERE headline LIKE '%Lennon%';
</code></pre>

<p>如果有百分号，则会进行转义：</p>

<pre><code class="language-python">Entry.objects.filter(headline__contains='%')
</code></pre>

<p>转义为：</p>

<pre><code class="language-sql">SELECT ... WHERE headline LIKE '%\%%';
</code></pre>

<p>d、in 查询</p>

<pre><code class="language-python"># Get blogs  with id 1, 4 and 7
Entry.objects.filter(pk__in=[1,4,7])
</code></pre>

<h4 id="section-5">跨关系查询</h4>

<p>跨关系查询是针对有主外键依赖关系的对象而言的，例如上面的 Author 和 Entry 对象是多对多的映射，可以通过 Entry 对象来过滤 Author的 name：</p>

<p>获取所有 blog 名称为 Beatles Blog 的 Entry 列表：</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.filter(blog__name='Beatles Blog')
</code></pre>

<p>也可以反向查询：</p>

<pre><code class="language-python">&gt;&gt;&gt; Blog.objects.filter(entry__headline__contains='Lennon')
</code></pre>

<p>如果跨越多层关系查询，中间模型没有值，django会作为空对待不会发生异常。</p>

<pre><code class="language-python">Blog.objects.filter(entry__authors__name='Lennon')
Blog.objects.filter(entry__authors__name__isnull=True)
Blog.objects.filter(entry__authors__isnull=False,
        entry__authors__name__isnull=True)
</code></pre>

<p>也支持多条件跨关系查询：</p>

<pre><code class="language-python">Blog.objects.filter(entry__headline__contains='Lennon',
        entry__pub_date__year=2008)
</code></pre>

<p>或者：</p>

<pre><code class="language-python">Blog.objects.filter(entry__headline__contains='Lennon').filter(
        entry__pub_date__year=2008)        
</code></pre>

<h4 id="extra--sql">使用 Extra 调整 SQL</h4>

<p>用extra可以修复QuerySet生成的原始SQL的各个部分，它接受四个关键字参数。如下：</p>

<ul>
  <li><code>select</code>：修改select语句</li>
  <li><code>where</code>：提供额外的where子句</li>
  <li><code>tables</code>：提供额外的表</li>
  <li><code>params</code>：安全的替换动态参数</li>
</ul>

<p>增加结果集以外的字段：</p>

<pre><code class="language-python">queryset.extra(select={'成年':'age&gt;18'}) 
</code></pre>

<p>提供额外的 where 条件：</p>

<pre><code class="language-python">queryset.extra(where=["first like '%小明%' "])
</code></pre>

<p>提供额外的表：</p>

<pre><code class="language-python">queryset.extra(tables=['myapp_person'])
</code></pre>

<p>安全的替换动态参数：</p>

<pre><code class="language-python">##'%s' is not replaced with normal string 
matches = Author.objects.all().extra(where=["first = '%s' "], params= [unknown-input ( ) ])
</code></pre>

<h4 id="f-">F 关键字参数</h4>

<p>前面给的例子里，我们建立了过滤，比照模型字段值和一个固定的值，但是如果我们想比较同一个模型里的一个字段和另一个字段的值，django 提供 <code>F()</code>——专门取对象中某列值的操作。</p>

<pre><code class="language-python">&gt;&gt;&gt; from django.db.models import F
&gt;&gt;&gt; Entry.objects.filter(n_comments__gt=F('n_pingbacks'))
</code></pre>

<p>当然，还支持加减乘除和模计算：</p>

<pre><code class="language-python">&gt;&gt;&gt; Entry.objects.filter(n_comments__gt=F('n_pingbacks') * 2)
&gt;&gt;&gt; Entry.objects.filter(rating__lt=F('n_comments') + F('n_pingbacks'))
&gt;&gt;&gt; 
&gt;&gt;&gt; Entry.objects.filter(authors__name=F('blog__name'))
</code></pre>

<p>对于日期类型字段，可以使用 timedelta 方法：</p>

<pre><code class="language-python">&gt;&gt;&gt; from datetime import timedelta
&gt;&gt;&gt; Entry.objects.filter(mod_date__gt=F('pub_date') + timedelta(days=3))
</code></pre>

<p>还支持位操作 <code>.bitand()</code> 和 <code>.bitor()</code>：</p>

<pre><code class="language-python">&gt;&gt;&gt; F('somefield').bitand(16)
</code></pre>

<h4 id="section-6">主键查找</h4>

<p>Django 支持使用 pk 代替主键：</p>

<pre><code class="language-python">&gt;&gt;&gt; Blog.objects.get(id__exact=14) # Explicit form
&gt;&gt;&gt; Blog.objects.get(id=14) # __exact is implied
&gt;&gt;&gt; Blog.objects.get(pk=14) # pk implies id__exact
</code></pre>

<p>pk 还可以用于其他的查找类型：</p>

<pre><code class="language-python"># Get blogs entries with id 1, 4 and 7
&gt;&gt;&gt; Blog.objects.filter(pk__in=[1,4,7])

# Get all blog entries with id &gt; 14
&gt;&gt;&gt; Blog.objects.filter(pk__gt=14)

&gt;&gt;&gt; Entry.objects.filter(blog__id__exact=3) # Explicit form
&gt;&gt;&gt; Entry.objects.filter(blog__id=3)        # __exact is implied
&gt;&gt;&gt; Entry.objects.filter(blog__pk=3)        # __pk implies __id__exact
</code></pre>

<h4 id="q-">Q 关键字参数</h4>

<p>QuerySet 可以通过一个叫 Q 的关键字参数封装类进一步参数化，允许使用更复杂的逻辑查询。其结果 Q对 象可以作为 filter 或 exclude 方法的关键字参数。</p>

<p>例子：</p>

<pre><code class="language-python">from django.db.models import Q
Q(question__startswith='What')
</code></pre>

<table>
  <tbody>
    <tr>
      <td>支持 &amp; 和</td>
      <td>操作符：</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-python">Q(question__startswith='Who') | Q(question__startswith='What')
</code></pre>

<p>上面的查询翻译成 sql 语句：</p>

<pre><code class="language-sql">WHERE question LIKE 'Who%' OR question LIKE 'What%'
</code></pre>

<p>取反操作：</p>

<pre><code class="language-python">Q(question__startswith='Who') | ~Q(pub_date__year=2005)
</code></pre>

<p>也可以用在 <code>filter()</code>、<code>exclude()</code>、<code>get()</code> 中：</p>

<pre><code class="language-python">Poll.objects.get(
    Q(question__startswith='Who'),
    Q(pub_date=date(2005, 5, 2)) | Q(pub_date=date(2005, 5, 6))
)
</code></pre>

<p>翻译成 sql 语句为：</p>

<pre><code class="language-sql">SELECT * from polls WHERE question LIKE 'Who%'
    AND (pub_date = '2005-05-02' OR pub_date = '2005-05-06')
</code></pre>

<h2 id="section-7">删除对象</h2>

<pre><code class="language-python">&gt;&gt;&gt;entry = Entry.objects.get(pk=1)
&gt;&gt;&gt;entry.delete()
&gt;&gt;&gt;Blog.objects.all().delete()

&gt;&gt;&gt;Entry.objects.filter(pub_date__year=2005).delete()
</code></pre>

<h2 id="section-8">关系对象</h2>

<p>当对象之间存在映射关系或者关联时，该如何查询呢？</p>

<p>当你在模型里定义一个关系时，模型实例会有一个方便的 API 来访问关系对象。以下分几种映射关系分别描述。</p>

<h3 id="one-to-many">One-to-many关系</h3>

<p>如果一个对象有ForeignKey，这个模型实例访问关系对象通过简单的属性:</p>

<pre><code class="language-python">&gt;&gt;&gt; e = Entry.objects.get(id=2)
&gt;&gt;&gt; e.blog # Returns the related Blog object.
</code></pre>

<p>你可以凭借外键属性获取和赋值，修改外键值知道执行 <code>save()</code> 方法才会保存到数据库:</p>

<pre><code class="language-python">&gt;&gt;&gt; e = Entry.objects.get(id=2)
&gt;&gt;&gt; e.blog = some_blog
&gt;&gt;&gt; e.save()
</code></pre>

<p>如果关联的对象可以为空，则可以将关联对象职位 None，删除关联：</p>

<pre><code class="language-python">&gt;&gt;&gt; e = Entry.objects.get(id=2)
&gt;&gt;&gt; e.blog = None
&gt;&gt;&gt; e.save() # "UPDATE blog_entry SET blog_id = NULL ...;"
</code></pre>

<p>子查询：</p>

<pre><code class="language-python">&gt;&gt;&gt; e = Entry.objects.get(id=2)
&gt;&gt;&gt; print(e.blog)  # Hits the database to retrieve the associated Blog.
&gt;&gt;&gt; print(e.blog)  # Doesn't hit the database; uses cached version.
</code></pre>

<p>也可以使用 select_related() 方法，该方法会提前将关联对象查询出来：</p>

<pre><code class="language-python">&gt;&gt;&gt; e = Entry.objects.select_related().get(id=2)
&gt;&gt;&gt; print(e.blog)  # Doesn't hit the database; uses cached version.
&gt;&gt;&gt; print(e.blog)  # Doesn't hit the database; uses cached version.
</code></pre>

<p>你也可以通过 <code>模型_set</code> 来访问关系对象的另一边，在 Blog 对象并没有维护 Entry 列表，但是你可以通过下面方式从 Blog 对象访问 Entry 列表：</p>

<pre><code class="language-python">&gt;&gt;&gt; b = Blog.objects.get(id=1)
&gt;&gt;&gt; b.entry_set.all() # Returns all Entry objects related to Blog.

# b.entry_set is a Manager that returns QuerySets.
&gt;&gt;&gt; b.entry_set.filter(headline__contains='Lennon')
&gt;&gt;&gt; b.entry_set.count()
</code></pre>

<p><code>模型_set</code> 可以通过 <code>related_name</code> 属性来修改，例如将 Entry 模型中的定义修改为：</p>

<pre><code class="language-python"> blog = ForeignKey(Blog, related_name='entries')
</code></pre>

<p>上面的查询就会变成：</p>

<pre><code class="language-python">&gt;&gt;&gt; b = Blog.objects.get(id=1)
&gt;&gt;&gt; b.entries.all() # Returns all Entry objects related to Blog.

# b.entries is a Manager that returns QuerySets.
&gt;&gt;&gt; b.entries.filter(headline__contains='Lennon')
&gt;&gt;&gt; b.entries.count()
</code></pre>

<h3 id="many-to-many">Many-to-many关系</h3>

<pre><code class="language-python">e = Entry.objects.get(id=3)
e.authors.all() # Returns all Author objects for this Entry.
e.authors.count()
e.authors.filter(name__contains='John')

a = Author.objects.get(id=5)
a.entry_set.all() # Returns all Entry objects for this Author.
</code></pre>

<h3 id="one-to-one">One-to-one关系</h3>

<pre><code class="language-python">class EntryDetail(models.Model):
    entry = models.OneToOneField(Entry)
    details = models.TextField()

ed = EntryDetail.objects.get(id=2)
ed.entry # Returns the related Entry object.
</code></pre>

<p>当反向查询时：</p>

<pre><code class="language-python">e = Entry.objects.get(id=2)
e.entrydetail # returns the related EntryDetail object
</code></pre>

<p>这时候如果没有关联对象，则会抛出 <code>DoesNotExist</code> 异常。</p>

<p>并且还可以修改：</p>

<pre><code class="language-python">e.entrydetail = ed
</code></pre>

<h2 id="section-9">参考资料</h2>

<ul>
  <li><a href="https://docs.djangoproject.com/en/1.7/topics/db/queries/">Making queries</a></li>
  <li><a href="http://my.oschina.net/u/877170/blog/288334">Eclipse的django开发学习笔记（2）–模型（M）</a></li>
  <li><a href="http://www.pythontip.com/blog/post/6358/">Django：模型的使用</a></li>
  <li><a href="http://www.cnblogs.com/linjiqin/archive/2014/07/01/3817954.html">django orm总结</a></li>
</ul>

                    <br/>
                    <div class="well">
                        原创文章，转载请注明： 转载自<a href="http://blog.javachen.com">JavaChen Blog</a>，作者：<a href="http://blog.javachen.com/about.html">yuke</a><br/>
                        本文链接地址：<a href="/2015/01/15/django-orm.html">http://blog.javachen.com/2015/01/15/django-orm.html</a><br/>
                        本文基于<a target="_blank" title="Creative Commons Attribution 2.5 China Mainland License" href="http://creativecommons.org/licenses/by/2.5/cn/">署名2.5中国大陆许可协议</a>发布，欢迎转载、演绎或用于商业目的，但是必须保留本文署名和文章链接。
                        如您有任何疑问或者授权方面的协商，请邮件联系我</a>。
                    </div>
                    <div class="col-md-6">
                      <p class="text-success hidden-print"><i class="fa fa-external-link"></i> <a href="/2015/01/15/django-orm.html">Django中的ORM</a></p>
                    </div>
                    <div class="col-md-6">
                       <p class="meta hidden-print pull-right">
                        
                            <i class="fa fa-folder-open"></i>
                            
                            <a class="btn btn-default btn-sm" href="/categories.html#python">python</a>
                          
                        
                        
                            <i class="fa fa-tags"></i>
                            
                            <a class="btn btn-default btn-sm" href="/tags.html#python">python</a>
                          
                            <a class="btn btn-default btn-sm" href="/tags.html#django">django</a>
                          
                        </p>
                    </div>
               </div><!--#post-text-->
          </div><!--#post-->
      </div> <!--#content-->

      <div id="post-comment" class="hidden-print">
      
<div id="comments">
  <div class="ds-thread" data-thread-key="/2015/01/15/django-orm.html" data-url="http://blog.javachen.com/2015/01/15/django-orm.html" data-title="Django中的ORM"></div>
</div>



      </div>


          </div>
          <a href="#" class="btn back-to-top btn-dark btn-fixed-bottom hidden-print"><i class="fa fa-chevron-up"></i></a>
      </div>
      <div id="footer">
          <div class="container hidden-print">
              <p class="text-center"><i class="fa fa-copyright"></i> 2015 JavaChen Blog. Theme designed by <a href="/about.html" target="_blank" title="">yuke</a> with <a href="https://github.com/mojombo/jekyll/">Jekyll</a>, <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://fortawesome.github.com/Font-Awesome/">Font Awesome</a>.
  	            
            <script type="text/javascript">
                var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                document.write(unescape("%3Cspan id='cnzz_stat_icon_1256628929'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1256628929' type='text/javascript'%3E%3C/script%3E"));</script>
            
            
    </p>
          </div>
      </div>

      <script type="text/javascript" src="/static/contrib/jquery/jquery.min.js"></script>
      <script type="text/javascript" src="/static/contrib/bootstrap/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/contrib/qrcode/jquery.qrcode.min.js"></script>
      <script type="text/javascript" src="/static/contrib/showup/showup.js"></script>
      <script type="text/javascript" src="/static/js/core.js"></script>
      
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"javachen"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      

      <script type="text/javascript">
      $('#qr').qrcode({
          width: 128,
          height: 128,
          text: 'http://blog.javachen.com/2015/01/15/django-orm.html'
      });
      </script>
  </body>
</html>
