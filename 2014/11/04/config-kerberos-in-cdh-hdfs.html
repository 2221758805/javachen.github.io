<!DOCTYPE html>
<html lang="zh-cn">
        <head>
      <meta charset="utf-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
      <title>HDFS配置Kerberos认证 - JavaChen Blog</title>
      <meta name="author" content="Junez"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
      <link rel="canonical" href="http://blog.javachen.com/2014/11/04/config-kerberos-in-cdh-hdfs.html" />

      <link rel="stylesheet" href="/static/contrib/bootstrap/css/bootstrap.min.css" media="all" />
      <link rel="stylesheet" href="/static/css/style.css" media="all" />
      <link rel="stylesheet" href="/static/css/pygments.css" media="all" />
      <link rel="stylesheet" href="/static/contrib/font-awesome/css/font-awesome.min.css" media="all" />
      <link rel="stylesheet" type="text/css" href="/static/contrib/showup/showup.css" />

      <!-- atom & rss feed -->
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="JavaChen Blog RSS Feed" />
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="JavaChen Blog ATOM Feed" />

        <!-- fav and touch icons  -->
        <!-- Update these with your own images
        <link rel="shortcut icon" href="images/favicon.ico">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
        -->

      <meta name="renderer" content="webkit|ie-stand">
      <meta name="baidu-site-verification" content="3HAhaWRiyR" />
      <meta name="360-site-verification" content="9b7a87a1d52051c96644f0a9b8b79898" />
      <meta name="sogou_site_verification" content="ofwXWFdthV"/>
      <meta property="wb:webmaster" content="b6081b2b8ab84c60" />
    </head>

    <body>
      <!--[if lte IE 9]>
<div class="alert alert-warning">
  <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
  <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
</div>
<![endif]-->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">JavaChen Blog</a>
          <p class="navbar-text visible-lg tagline">Ramblings of a coder</p>
        </div>
        <div class="navbar-collapse collapse">
            <form id="search-form" class="form-group navbar-form navbar-right" role="search">
                  <div class="form-group">
                    <input type="text" name="q" value=""  id="query" class="form-control" placeholder="搜索" required autocomplete="off" ></input>
                    <input type="submit" class="btn btn-default" value=" Go" ></input>
                  </div>
              </form>
            <ul class="nav navbar-nav">
              <li><a href="/archive.html" title="Archive"><span class='fa fa-archive fa-2x'></span></a></li>
              <li><a href="/categories.html" title="Categories"><span class='fa fa-navicon fa-2x'></span></a></li>
              <li><a href="/tags.html" title="Tags"><span class='fa fa-tags fa-2x'></span></a></li>
              <li><a href="/about.html" title="About"><span class='fa fa-user fa-2x'></span></a></li>
              
              <li><a href="https://github.com/javachen" target="_blank" title="Github"><span class='fa fa-github fa-2x'></span></a></li>
              
              
              
              <li><a href="https://twitter.com/junezchen" target="_blank" title="twitter"><span class="fa fa-twitter fa-2x"></span></a></li>
              
              
              
              <li><a href="http://weibo.com/chenzhijun" target="_blank" title="Weibo"><span class="fa fa-weibo fa-2x"></span></a></li>
              
              <li><a href="/rss.xml" target="_blank" title="RSS"><span class='fa fa-rss fa-2x'></span></a></li>
            </ul>
        </div>

        </div><!--/.nav-collapse -->
      </div>
</div>

      <div id="wrap">
          <div class="container">
                 <div id="content">
          <ul class="pager hidden-print">
               
                <li class="previous"><a href="/2014/10/30/install-postgresql-on-mac-using-homebrew.html" title="Mac上使用homebrew安装PostgreSql"><i class="fa fa-angle-double-left"></i>&nbsp;Mac上使用homebrew安装PostgreSql</a></li>
                
                
                <li class="next"><a href="/2014/11/05/config-kerberos-in-cdh-yarn.html" title="YARN配置Kerberos认证">YARN配置Kerberos认证&nbsp;<i class="fa fa-angle-double-right"></i></a></li>
                
          </ul>

           <div id="post" class="clearfix">
              <div id="post-title" class="page-header text-center">
                  <h1> HDFS配置Kerberos认证  </h1>
              </div>
              <p class="text-muted clearfix">
                  <span class="pull-right">2014.11.04 | <a href="#comments">Comments</a></span>
              </p>
              <div id="qr" class="qrcode visible-lg"></div>

              <div id="post-text">
                    <p>本文主要记录 CDH Hadoop 集群上配置 HDFS 集成 Kerberos 的过程，包括 Kerberos 的安装和 Hadoop 相关配置修改说明。</p>

<h1 id="1.-环境说明">1. 环境说明</h1>

<p>系统环境：</p>

<ul>
<li>操作系统：CentOs 6.6</li>
<li>Hadoop版本：<code class="prettyprint">CDH5.4</code></li>
<li>JDK版本：<code class="prettyprint">1.7.0_71</code></li>
<li>运行用户：root</li>
</ul>

<p>集群各节点角色规划为：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">192.168.56.121        cdh1     NameNode、ResourceManager、HBase、Hive metastore、Impala Catalog、Impala statestore、Sentry 
192.168.56.122        cdh2     DataNode、SecondaryNameNode、NodeManager、HBase、Hive Server2、Impala Server
192.168.56.123        cdh3     DataNode、HBase、NodeManager、Hive Server2、Impala Server
</code></pre></div>
<p>cdh1作为master节点，其他节点作为slave节点，我们在cdh1节点安装kerberos Server，在其他节点安装kerberos client。</p>

<h1 id="2.-准备工作">2. 准备工作</h1>

<p>确认添加主机名解析到 <code class="prettyprint">/etc/hosts</code> 文件中。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>cat /etc/hosts
127.0.0.1       localhost

192.168.56.121 cdh1
192.168.56.122 cdh2
192.168.56.123 cdh3
</code></pre></div>
<p>注意：hostname 请使用小写，要不然在集成 kerberos 时会出现一些错误。</p>

<h1 id="3.-安装-kerberos">3. 安装 Kerberos</h1>

<p>在 cdh1 上安装包 krb5、krb5-server 和 krb5-client。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>yum install krb5-server -y
</code></pre></div>
<p>在其他节点（cdh1、cdh2、cdh3）安装 krb5-devel、krb5-workstation ：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#使用无密码登陆</span>
<span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;yum install krb5-devel krb5-workstation -y&quot;</span>
<span class="nv">$ </span>ssh cdh2 <span class="s2">&quot;yum install krb5-devel krb5-workstation -y&quot;</span>
<span class="nv">$ </span>ssh cdh3 <span class="s2">&quot;yum install krb5-devel krb5-workstation -y&quot;</span>
</code></pre></div>
<h1 id="4.-修改配置文件">4. 修改配置文件</h1>

<p>kdc 服务器涉及到三个配置文件：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/etc/krb5.conf
/var/kerberos/krb5kdc/kdc.conf
/var/kerberos/krb5kdc/kadm5.acl
</code></pre></div>
<p>配置 Kerberos 的一种方法是编辑配置文件 /etc/krb5.conf。默认安装的文件中包含多个示例项。</p>
<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="k">[logging]</span>
 <span class="na">default</span> <span class="o">=</span> <span class="s">FILE:/var/log/krb5libs.log</span>
<span class="s"> kdc = FILE:/var/log/krb5kdc.log</span>
<span class="s"> admin_server = FILE:/var/log/kadmind.log</span>

<span class="k">[libdefaults]</span>
 <span class="na">default_realm</span> <span class="o">=</span> <span class="s">JAVACHEN.COM</span>
<span class="s"> dns_lookup_realm = false</span>
<span class="s"> dns_lookup_kdc = false</span>
<span class="s"> ticket_lifetime = 24h</span>
<span class="s"> renew_lifetime = 7d</span>
<span class="s"> forwardable = true</span>
<span class="s"> default_tgs_enctypes = aes256-cts-hmac-sha1-96</span>
<span class="s"> default_tkt_enctypes = aes256-cts-hmac-sha1-96</span>
<span class="s"> permitted_enctypes = aes256-cts-hmac-sha1-96</span>
<span class="s"> clockskew = 120</span>
<span class="s"> udp_preference_limit = 1</span>

<span class="k">[realms]</span>
 <span class="na">JAVACHEN.COM</span> <span class="o">=</span> <span class="s">{</span>
<span class="s">  kdc = cdh1</span>
<span class="s">  admin_server = cdh1</span>
<span class="s"> }</span>

<span class="k">[domain_realm]</span>
 <span class="na">.javachen.com</span> <span class="o">=</span> <span class="s">JAVACHEN.COM</span>
<span class="s"> javachen.com = JAVACHEN.COM</span>
</code></pre></div>
<p>说明：</p>

<ul>
<li><code class="prettyprint">[logging]</code>：表示 server 端的日志的打印位置</li>
<li><p><code class="prettyprint">[libdefaults]</code>：每种连接的默认配置，需要注意以下几个关键的小配置</p>

<ul>
<li><code class="prettyprint">default_realm = JAVACHEN.COM</code>：设置 Kerberos 应用程序的默认领域。如果您有多个领域，只需向 [realms] 节添加其他的语句。</li>
<li><code class="prettyprint">ticket_lifetime</code>： 表明凭证生效的时限，一般为24小时。</li>
<li><code class="prettyprint">renew_lifetime</code>： 表明凭证最长可以被延期的时限，一般为一个礼拜。当凭证过期之后，对安全认证的服务的后续访问则会失败。</li>
<li><code class="prettyprint">clockskew</code>：时钟偏差是不完全符合主机系统时钟的票据时戳的容差，超过此容差将不接受此票据。通常，将时钟扭斜设置为 300 秒（5 分钟）。这意味着从服务器的角度看，票证的时间戳与它的偏差可以是在前后 5 分钟内。</li>
<li><code class="prettyprint">udp_preference_limit= 1</code>：禁止使用 udp 可以防止一个 Hadoop 中的错误</li>
</ul></li>
<li><p><code class="prettyprint">[realms]</code>：列举使用的 realm。</p>

<ul>
<li><code class="prettyprint">kdc</code>：代表要 kdc 的位置。格式是 <code class="prettyprint">机器:端口</code></li>
<li><code class="prettyprint">admin_server</code>：代表 admin 的位置。格式是 <code class="prettyprint">机器:端口</code></li>
<li><code class="prettyprint">default_domain</code>：代表默认的域名</li>
</ul></li>
<li><p><code class="prettyprint">[appdefaults]</code>：可以设定一些针对特定应用的配置，覆盖默认配置。</p></li>
</ul>

<p>修改 <code class="prettyprint">/var/kerberos/krb5kdc/kdc.conf</code> ，该文件包含 Kerberos 的配置信息。例如，KDC 的位置，Kerbero 的 admin 的realms 等。需要所有使用的 Kerberos 的机器上的配置文件都同步。这里仅列举需要的基本配置。详细介绍参考：<a href="http://web.mit.edu/%7Ekerberos/krb5-devel/doc/admin/conf_files/krb5_conf.html">krb5conf</a></p>
<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="k">[kdcdefaults]</span>
 <span class="na">kdc_ports</span> <span class="o">=</span> <span class="s">88</span>
<span class="s"> kdc_tcp_ports = 88</span>

<span class="k">[realms]</span>
 <span class="na">JAVACHEN.COM</span> <span class="o">=</span> <span class="s">{</span>
<span class="s">  #master_key_type = aes256-cts</span>
<span class="s">  acl_file = /var/kerberos/krb5kdc/kadm5.acl</span>
<span class="s">  dict_file = /usr/share/dict/words</span>
<span class="s">  max_renewable_life = 7d</span>
<span class="s">  max_life = 1d</span>
<span class="s">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</span>
<span class="s">  supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</span>
<span class="s">  default_principal_flags = +renewable, +forwardable</span>
<span class="s"> }</span>
</code></pre></div>
<p>说明：</p>

<ul>
<li><code class="prettyprint">JAVACHEN.COM</code>： 是设定的 realms。名字随意。Kerberos 可以支持多个 realms，会增加复杂度。大小写敏感，一般为了识别使用全部大写。这个 realms 跟机器的 host 没有大关系。</li>
<li><code class="prettyprint">master_key_type</code>：和 <code class="prettyprint">supported_enctypes</code> 默认使用 <code class="prettyprint">aes256-cts</code>。JAVA 使用 <code class="prettyprint">aes256-cts</code> 验证方式需要安装 JCE 包，见下面的说明。为了简便，你可以不使用 <code class="prettyprint">aes256-cts</code> 算法，这样就不需要安装 JCE 。</li>
<li><code class="prettyprint">acl_file</code>：标注了 admin 的用户权限，需要用户自己创建。文件格式是：<code class="prettyprint">Kerberos_principal permissions [target_principal]  [restrictions]</code></li>
<li><code class="prettyprint">supported_enctypes</code>：支持的校验方式。</li>
<li><code class="prettyprint">admin_keytab</code>：KDC 进行校验的 keytab。</li>
</ul>

<blockquote>
<p><strong>关于AES-256加密</strong>：</p>

<p>对于使用 centos5. 6 及以上的系统，默认使用 <code class="prettyprint">AES-256</code> 来加密的。这就需要集群中的所有节点上安装 JCE，如果你使用的是 JDK1.6 ，则到<br>
 <a href="http://www.oracle.com/technetwork/java/javase/downloads/jce-6-download-429243.html">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for JDK/JRE 6</a> 页面下载，如果是 JDK1.7，则到 <a href="http://www.oracle.com/technetwork/java/embedded/embedded-se/downloads/jce-7-download-432124.html">Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files for JDK/JRE 7</a> 下载。</p>

<p>下载的文件是一个 zip 包，解开后，将里面的两个文件放到下面的目录中：<code class="prettyprint">$JAVA_HOME/jre/lib/security</code></p>
</blockquote>

<p>为了能够不直接访问 KDC 控制台而从 Kerberos 数据库添加和删除主体，请对 Kerberos 管理服务器指示允许哪些主体执行哪些操作。通过编辑文件 /var/lib/kerberos/krb5kdc/kadm5.acl 完成此操作。ACL（访问控制列表）允许您精确指定特权。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>cat /var/kerberos/krb5kdc/kadm5.acl
  */admin@JAVACHEN.COM *
</code></pre></div>
<h1 id="5.-同步配置文件">5. 同步配置文件</h1>

<p>将 kdc 中的 <code class="prettyprint">/etc/krb5.conf</code> 拷贝到集群中其他服务器即可。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>scp /etc/krb5.conf cdh2:/etc/krb5.conf
<span class="nv">$ </span>scp /etc/krb5.conf cdh3:/etc/krb5.conf
</code></pre></div>
<p>请确认集群如果关闭了 selinux。</p>

<h1 id="6.-创建数据库">6. 创建数据库</h1>

<p>在 cdh1 上运行初始化数据库命令。其中 <code class="prettyprint">-r</code> 指定对应 realm。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kdb5_util create -r JAVACHEN.COM -s
</code></pre></div>
<p>出现 <code class="prettyprint">Loading random data</code> 的时候另开个终端执行点消耗CPU的命令如 <code class="prettyprint">cat /dev/sda &gt; /dev/urandom</code> 可以加快随机数采集。该命令会在 <code class="prettyprint">/var/kerberos/krb5kdc/</code> 目录下创建 principal 数据库。</p>

<p>如果遇到数据库已经存在的提示，可以把 <code class="prettyprint">/var/kerberos/krb5kdc/</code> 目录下的 principal 的相关文件都删除掉。默认的数据库名字都是 principal。可以使用 <code class="prettyprint">-d</code> 指定数据库名字。</p>

<h1 id="7.-启动服务">7. 启动服务</h1>

<p>在 cdh1 节点上运行：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>chkconfig --level <span class="m">35</span> krb5kdc on
<span class="nv">$ </span>chkconfig --level <span class="m">35</span> kadmin on
<span class="nv">$ </span>service krb5kdc start
<span class="nv">$ </span>service kadmin start
</code></pre></div>
<h1 id="8.-创建-kerberos-管理员">8. 创建 kerberos 管理员</h1>

<p>关于 kerberos 的管理，可以使用 <code class="prettyprint">kadmin.local</code> 或 <code class="prettyprint">kadmin</code>，至于使用哪个，取决于账户和访问权限：</p>

<ul>
<li>如果有访问 kdc 服务器的 root 权限，但是没有 kerberos admin 账户，使用 <code class="prettyprint">kadmin.local</code></li>
<li>如果没有访问 kdc 服务器的 root 权限，但是用 kerberos admin 账户，使用 <code class="prettyprint">kadmin</code></li>
</ul>

<p>在 cdh1 上创建远程管理的管理员：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#手动输入两次密码，这里密码为 root</span>
<span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;addprinc root/admin&quot;</span>

<span class="c"># 也可以不用手动输入密码</span>
<span class="nv">$ </span><span class="nb">echo</span> -e <span class="s2">&quot;root\nroot&quot;</span> <span class="p">|</span> kadmin.local -q <span class="s2">&quot;addprinc root/admin&quot;</span>

<span class="c"># 或者运行下面命令</span>
<span class="nv">$ </span>kadmin.local <span class="s">&lt;&lt;eoj</span>
<span class="s">addprinc -pw root root/admin</span>
<span class="s">eoj</span>
</code></pre></div>
<p>系统会提示输入密码，密码不能为空，且需妥善保存。</p>

<h1 id="9.-测试-kerberos">9. 测试 kerberos</h1>

<p>查看当前的认证用户：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># 查看principals</span>
<span class="nv">$ </span>kadmin: list_principals

  <span class="c"># 添加一个新的 principal</span>
  kadmin:  addprinc user1
    WARNING: no policy specified <span class="k">for</span> user1@JAVACHEN.COM<span class="p">;</span> defaulting to no policy
    Enter password <span class="k">for</span> principal <span class="s2">&quot;user1@JAVACHEN.COM&quot;</span>:
    Re-enter password <span class="k">for</span> principal <span class="s2">&quot;user1@JAVACHEN.COM&quot;</span>:
    Principal <span class="s2">&quot;user1@JAVACHEN.COM&quot;</span> created.

  <span class="c"># 删除 principal</span>
  kadmin:  delprinc user1
    Are you sure you want to delete the principal <span class="s2">&quot;user1@JAVACHEN.COM&quot;</span>? <span class="o">(</span>yes/no<span class="o">)</span>: yes
    Principal <span class="s2">&quot;user1@JAVACHEN.COM&quot;</span> deleted.
    Make sure that you have removed this principal from all ACLs before reusing.

  kadmin: <span class="nb">exit</span>
</code></pre></div>
<p>也可以直接通过下面的命令来执行：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># 提示需要输入密码</span>
<span class="nv">$ </span>kadmin -p root/admin -q <span class="s2">&quot;list_principals&quot;</span>
<span class="nv">$ </span>kadmin -p root/admin -q <span class="s2">&quot;addprinc user2&quot;</span>
<span class="nv">$ </span>kadmin -p root/admin -q <span class="s2">&quot;delprinc user2&quot;</span>

<span class="c"># 不用输入密码</span>
<span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;list_principals&quot;</span>
<span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;addprinc user2&quot;</span>
<span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;delprinc user2&quot;</span>
</code></pre></div>
<p>创建一个测试用户 test，密码设置为 test：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> -e <span class="s2">&quot;test\ntest&quot;</span> <span class="p">|</span> kadmin.local -q <span class="s2">&quot;addprinc test&quot;</span>
</code></pre></div>
<p>获取 test 用户的 ticket：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># 通过用户名和密码进行登录</span>
<span class="nv">$ </span>kinit <span class="nb">test</span>
Password <span class="k">for</span> <span class="nb">test</span>@JAVACHEN.COM:

<span class="nv">$ </span>klist  -e
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: <span class="nb">test</span>@JAVACHEN.COM

Valid starting     Expires            Service principal
11/07/14 15:29:02  11/08/14 15:29:02  krbtgt/JAVACHEN.COM@JAVACHEN.COM
  renew <span class="k">until</span> 11/17/14 15:29:02, Etype <span class="o">(</span>skey, tkt<span class="o">)</span>: aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96

Kerberos <span class="m">4</span> ticket cache: /tmp/tkt0
klist: You have no tickets cached
</code></pre></div>
<p>销毁该 test 用户的 ticket：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kdestroy

<span class="nv">$ </span>klist
klist: No credentials cache found <span class="o">(</span>ticket cache FILE:/tmp/krb5cc_0<span class="o">)</span>

Kerberos <span class="m">4</span> ticket cache: /tmp/tkt0
klist: You have no tickets cached
</code></pre></div>
<p>更新 ticket：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kinit root/admin
  Password <span class="k">for</span> root/admin@JAVACHEN.COM:

<span class="nv">$ </span> klist
  Ticket cache: FILE:/tmp/krb5cc_0
  Default principal: root/admin@JAVACHEN.COM

  Valid starting     Expires            Service principal
  11/07/14 15:33:57  11/08/14 15:33:57  krbtgt/JAVACHEN.COM@JAVACHEN.COM
    renew <span class="k">until</span> 11/17/14 15:33:57

  Kerberos <span class="m">4</span> ticket cache: /tmp/tkt0
  klist: You have no tickets cached

<span class="nv">$ </span>kinit -R

<span class="nv">$ </span>klist
  Ticket cache: FILE:/tmp/krb5cc_0
  Default principal: root/admin@JAVACHEN.COM

  Valid starting     Expires            Service principal
  11/07/14 15:34:05  11/08/14 15:34:05  krbtgt/JAVACHEN.COM@JAVACHEN.COM
    renew <span class="k">until</span> 11/17/14 15:33:57

  Kerberos <span class="m">4</span> ticket cache: /tmp/tkt0
  klist: You have no tickets cached
</code></pre></div>
<p>抽取密钥并将其储存在本地 keytab 文件 /etc/krb5.keytab 中。这个文件由超级用户拥有，所以您必须是 root 用户才能在 kadmin shell 中执行以下命令：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;ktadd kadmin/admin&quot;</span>

<span class="nv">$ </span>klist -k /etc/krb5.keytab
  Keytab name: FILE:/etc/krb5.keytab
  KVNO Principal
  ---- --------------------------------------------------------------------------
     <span class="m">3</span> kadmin/admin@LASHOU-INC.COM
     <span class="m">3</span> kadmin/admin@LASHOU-INC.COM
     <span class="m">3</span> kadmin/admin@LASHOU-INC.COM
     <span class="m">3</span> kadmin/admin@LASHOU-INC.COM
     <span class="m">3</span> kadmin/admin@LASHOU-INC.COM
</code></pre></div>
<h1 id="10.-hdfs-上配置-kerberos">10. HDFS 上配置 kerberos</h1>

<h2 id="10.1-创建认证规则">10.1 创建认证规则</h2>

<p>在 Kerberos 安全机制里，一个 principal 就是 realm 里的一个对象，一个 principal 总是和一个密钥（secret key）成对出现的。</p>

<p>这个 principal 的对应物可以是 service，可以是 host，也可以是 user，对于 Kerberos 来说，都没有区别。</p>

<p>Kdc(Key distribute center) 知道所有 principal 的 secret key，但每个 principal 对应的对象只知道自己的那个 secret key 。这也是“共享密钥“的由来。</p>

<p>对于 hadoop，principals 的格式为 <code class="prettyprint">username/fully.qualified.domain.name@YOUR-REALM.COM</code>。</p>

<p>通过 yum 源安装的 cdh 集群中，NameNode 和 DataNode 是通过 hdfs 启动的，故为集群中每个服务器节点添加两个principals：hdfs、HTTP。</p>

<p>在 KCD server 上（这里是 cdh1）创建 hdfs principal：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">kadmin.local -q <span class="s2">&quot;addprinc -randkey hdfs/cdh1@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;addprinc -randkey hdfs/cdh2@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;addprinc -randkey hdfs/cdh3@JAVACHEN.COM&quot;</span>
</code></pre></div>
<p><code class="prettyprint">-randkey</code> 标志没有为新 principal 设置密码，而是指示 kadmin 生成一个随机密钥。之所以在这里使用这个标志，是因为此 principal 不需要用户交互。它是计算机的一个服务器帐户。</p>

<p>创建 HTTP principal：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">kadmin.local -q <span class="s2">&quot;addprinc -randkey HTTP/cdh1@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;addprinc -randkey HTTP/cdh2@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;addprinc -randkey HTTP/cdh3@JAVACHEN.COM&quot;</span>
</code></pre></div>
<p>创建完成后，查看：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kadmin.local -q <span class="s2">&quot;listprincs&quot;</span>
</code></pre></div>
<h2 id="10.2-创建keytab文件">10.2 创建keytab文件</h2>

<p>keytab 是包含 principals 和加密 principal key 的文件。keytab 文件对于每个 host 是唯一的，因为 key 中包含 hostname。keytab 文件用于不需要人工交互和保存纯文本密码，实现到 kerberos 上验证一个主机上的 principal。因为服务器上可以访问 keytab 文件即可以以 principal 的身份通过 kerberos 的认证，所以，keytab 文件应该被妥善保存，应该只有少数的用户可以访问。</p>

<p>创建包含 hdfs principal 和 host principal 的 hdfs keytab：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xst -norandkey -k hdfs.keytab hdfs/fully.qualified.domain.name host/fully.qualified.domain.name
</code></pre></div>
<p>创建包含 mapred principal 和 host principal 的 mapred keytab：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">xst -norandkey -k mapred.keytab mapred/fully.qualified.domain.name host/fully.qualified.domain.name
</code></pre></div>
<blockquote>
<p><strong>注意</strong>：<br>
上面的方法使用了xst的norandkey参数，有些kerberos不支持该参数。<br>
当不支持该参数时有这样的提示：<code class="prettyprint">Principal -norandkey does not exist.</code>，需要使用下面的方法来生成keytab文件。</p>
</blockquote>

<p>在 cdh1 节点，即 KDC server 节点上执行下面命令：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /var/kerberos/krb5kdc/

kadmin.local -q <span class="s2">&quot;xst  -k hdfs-unmerged.keytab  hdfs/cdh1@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;xst  -k hdfs-unmerged.keytab  hdfs/cdh2@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;xst  -k hdfs-unmerged.keytab  hdfs/cdh3@JAVACHEN.COM&quot;</span>

kadmin.local -q <span class="s2">&quot;xst  -k HTTP.keytab  HTTP/cdh1@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;xst  -k HTTP.keytab  HTTP/cdh2@JAVACHEN.COM&quot;</span>
kadmin.local -q <span class="s2">&quot;xst  -k HTTP.keytab  HTTP/cdh3@JAVACHEN.COM&quot;</span>
</code></pre></div>
<p>这样，就会在 <code class="prettyprint">/var/kerberos/krb5kdc/</code> 目录下生成 <code class="prettyprint">hdfs-unmerged.keytab</code> 和 <code class="prettyprint">HTTP.keytab</code> 两个文件，接下来使用 <code class="prettyprint">ktutil</code> 合并者两个文件为 <code class="prettyprint">hdfs.keytab</code>。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /var/kerberos/krb5kdc/

<span class="nv">$ </span>ktutil
ktutil: rkt hdfs-unmerged.keytab
ktutil: rkt HTTP.keytab
ktutil: wkt hdfs.keytab
ktutil: <span class="nb">exit</span>
</code></pre></div>
<p>使用 klist 显示 hdfs.keytab 文件列表：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>klist -ket  hdfs.keytab
Keytab name: FILE:hdfs.keytab
KVNO Timestamp         Principal
---- ----------------- --------------------------------------------------------
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh1@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh2@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 hdfs/cdh3@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh1@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh2@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>aes256-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>aes128-cts-hmac-sha1-96<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>des3-cbc-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>arcfour-hmac<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>des-hmac-sha1<span class="o">)</span>
   <span class="m">2</span> 11/13/14 10:40:18 HTTP/cdh3@JAVACHEN.COM <span class="o">(</span>des-cbc-md5<span class="o">)</span>
</code></pre></div>
<p>验证是否正确合并了key，使用合并后的keytab，分别使用hdfs和host principals来获取证书。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kinit -k -t hdfs.keytab hdfs/cdh1@JAVACHEN.COM
<span class="nv">$ </span>kinit -k -t hdfs.keytab HTTP/cdh1@JAVACHEN.COM
</code></pre></div>
<p>如果出现错误：<code class="prettyprint">kinit: Key table entry not found while getting initial credentials</code>，<br>
则上面的合并有问题，重新执行前面的操作。</p>

<h2 id="10.3-部署kerberos-keytab文件">10.3 部署kerberos keytab文件</h2>

<p>拷贝 hdfs.keytab 文件到其他节点的 /etc/hadoop/conf 目录</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /var/kerberos/krb5kdc/

<span class="nv">$ </span>scp hdfs.keytab cdh1:/etc/hadoop/conf
<span class="nv">$ </span>scp hdfs.keytab cdh2:/etc/hadoop/conf
<span class="nv">$ </span>scp hdfs.keytab cdh3:/etc/hadoop/conf
</code></pre></div>
<p>并设置权限，分别在 cdh1、cdh2、cdh3 上执行：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;chown hdfs:hadoop /etc/hadoop/conf/hdfs.keytab ;chmod 400 /etc/hadoop/conf/hdfs.keytab&quot;</span>
<span class="nv">$ </span>ssh cdh2 <span class="s2">&quot;chown hdfs:hadoop /etc/hadoop/conf/hdfs.keytab ;chmod 400 /etc/hadoop/conf/hdfs.keytab&quot;</span>
<span class="nv">$ </span>ssh cdh3 <span class="s2">&quot;chown hdfs:hadoop /etc/hadoop/conf/hdfs.keytab ;chmod 400 /etc/hadoop/conf/hdfs.keytab&quot;</span>
</code></pre></div>
<p>由于 keytab 相当于有了永久凭证，不需要提供密码(如果修改kdc中的principal的密码，则该keytab就会失效)，所以其他用户如果对该文件有读权限，就可以冒充 keytab 中指定的用户身份访问 hadoop，所以 keytab 文件需要确保只对 owner 有读权限(0400)</p>

<h2 id="10.4-修改-hdfs-配置文件">10.4 修改 hdfs 配置文件</h2>

<p>先停止集群：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="k">for</span> x in <span class="sb">`</span><span class="nb">cd</span> /etc/init.d <span class="p">;</span> ls hive-*<span class="sb">`</span> <span class="p">;</span> <span class="k">do</span> sudo service <span class="nv">$x</span> stop <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for</span> x in <span class="sb">`</span><span class="nb">cd</span> /etc/init.d <span class="p">;</span> ls impala-*<span class="sb">`</span> <span class="p">;</span> <span class="k">do</span> sudo service <span class="nv">$x</span> stop <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for</span> x in <span class="sb">`</span><span class="nb">cd</span> /etc/init.d <span class="p">;</span> ls hadoop-*<span class="sb">`</span> <span class="p">;</span> <span class="k">do</span> sudo service <span class="nv">$x</span> stop <span class="p">;</span> <span class="k">done</span>
<span class="nv">$ </span><span class="k">for</span> x in <span class="sb">`</span><span class="nb">cd</span> /etc/init.d <span class="p">;</span> ls zookeeper-*<span class="sb">`</span> <span class="p">;</span> <span class="k">do</span> sudo service <span class="nv">$x</span> stop <span class="p">;</span> <span class="k">done</span>
</code></pre></div>
<p>在集群中所有节点的 core-site.xml 文件中添加下面的配置:</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>hadoop.security.authentication<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>kerberos<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>hadoop.security.authorization<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div>
<p>在集群中所有节点的 hdfs-site.xml 文件中添加下面的配置：</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.block.access.token.enable<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>  
  <span class="nt">&lt;name&gt;</span>dfs.datanode.data.dir.perm<span class="nt">&lt;/name&gt;</span>  
  <span class="nt">&lt;value&gt;</span>700<span class="nt">&lt;/value&gt;</span>  
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.namenode.keytab.file<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/etc/hadoop/conf/hdfs.keytab<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.namenode.kerberos.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>hdfs/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.namenode.kerberos.https.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>HTTP/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.datanode.address<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>0.0.0.0:1004<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.datanode.http.address<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>0.0.0.0:1006<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.datanode.keytab.file<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/etc/hadoop/conf/hdfs.keytab<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.datanode.kerberos.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>hdfs/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.datanode.kerberos.https.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>HTTP/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div>
<p>如果想开启 SSL，请添加（本文不对这部分做说明）：</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.http.policy<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>HTTPS_ONLY<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div>
<p>如果 HDFS 配置了 QJM HA，则需要添加（另外，你还要在 zookeeper 上配置 kerberos）：</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.journalnode.keytab.file<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/etc/hadoop/conf/hdfs.keytab<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.journalnode.kerberos.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>hdfs/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.journalnode.kerberos.internal.spnego.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>HTTP/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div>
<p>如果配置了 WebHDFS，则添加：</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.webhdfs.enabled<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.web.authentication.kerberos.principal<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>HTTP/_HOST@JAVACHEN.COM<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>dfs.web.authentication.kerberos.keytab<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/etc/hadoop/conf/hdfs.keytab<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div>
<p>配置中有几点要注意的：</p>

<ul>
<li>1. <code class="prettyprint">dfs.datanode.address</code>表示 data transceiver RPC server 所绑定的 hostname 或 IP 地址，如果开启 security，端口号必须小于 <code class="prettyprint">1024</code>(privileged port)，否则的话启动 datanode 时候会报 <code class="prettyprint">Cannot start secure cluster without privileged resources</code> 错误</li>
<li>2. principal 中的 instance 部分可以使用 <code class="prettyprint">_HOST</code> 标记，系统会自动替换它为全称域名</li>
<li>3. 如果开启了 security, hadoop 会对 hdfs block data(由 <code class="prettyprint">dfs.data.dir</code> 指定)做 permission check，方式用户的代码不是调用hdfs api而是直接本地读block data，这样就绕过了kerberos和文件权限验证，管理员可以通过设置 <code class="prettyprint">dfs.datanode.data.dir.perm</code> 来修改 datanode 文件权限，这里我们设置为700</li>
</ul>

<h2 id="10.5-检查集群上的-hdfs-和本地文件的权限">10.5 检查集群上的 HDFS 和本地文件的权限</h2>

<p>请参考 <a href="http://www.cloudera.com/content/cloudera/en/documentation/core/latest/topics/cdh_sg_users_groups_verify.html">Verify User Accounts and Groups in CDH 5 Due to Security</a> 或者 <a href="http://hadoop.apache.org/docs/r2.5.0/hadoop-project-dist/hadoop-common/SecureMode.html">Hadoop in Secure Mode</a>。</p>

<h2 id="10.6-启动-namenode">10.6 启动 NameNode</h2>

<p>启动之前，请确认 JCE jar 已经替换，请参考前面的说明。</p>

<p>在每个节点上获取 root 用户的 ticket，这里 root 为之前创建的 root/admin 的密码。</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;echo root|kinit root/admin&quot;</span>
<span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;echo root|kinit root/admin&quot;</span>
<span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;echo root|kinit root/admin&quot;</span>
</code></pre></div>
<p>获取 cdh1的 ticket：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>kinit -k -t /etc/hadoop/conf/hdfs.keytab hdfs/cdh1@JAVACHEN.COM
</code></pre></div>
<p>如果出现下面异常 <code class="prettyprint">kinit: Password incorrect while getting initial credentials</code>，则重新导出 keytab 再试试。</p>

<p>然后启动服务，观察日志：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>/etc/init.d/hadoop-hdfs-namenode start
</code></pre></div>
<p>验证 NameNode 是否启动，一是打开 web 界面查看启动状态，一是运行下面命令查看 hdfs：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>hadoop fs -ls /
Found <span class="m">4</span> items
drwxrwxrwx   - yarn hadoop          <span class="m">0</span> 2014-06-26 15:24 /logroot
drwxrwxrwt   - hdfs hadoop          <span class="m">0</span> 2014-11-04 10:44 /tmp
drwxr-xr-x   - hdfs hadoop          <span class="m">0</span> 2014-08-10 10:53 /user
drwxr-xr-x   - hdfs hadoop          <span class="m">0</span> 2013-05-20 22:52 /var
</code></pre></div>
<p>如果在你的凭据缓存中没有有效的 kerberos ticket，执行上面命令将会失败，将会出现下面的错误：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">14/11/04 12:08:12 WARN ipc.Client: Exception encountered while connecting to the server : javax.security.sasl.SaslException:
GSS initiate failed [Caused by GS***ception: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]
Bad connection to FS. command aborted. exception: Call to cdh1/192.168.56.121:8020 failed on local exception: java.io.IOException:
javax.security.sasl.SaslException: GSS initiate failed [Caused by GS***ception: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]
</code></pre></div>
<h2 id="10.7-启动datanode">10.7 启动DataNode</h2>

<p>DataNode 需要通过 JSVC 启动。首先检查是否安装了 JSVC 命令，然后配置环境变量。</p>

<p>在 cdh1 节点查看是否安装了 JSVC：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ls /usr/lib/bigtop-utils/
bigtop-detect-classpath  bigtop-detect-javahome  bigtop-detect-javalibs  jsvc
</code></pre></div>
<p>然后编辑 <code class="prettyprint">/etc/default/hadoop-hdfs-datanode</code>，取消对下面的注释并添加一行设置 <code class="prettyprint">JSVC_HOME</code>，修改如下：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">HADOOP_SECURE_DN_USER</span><span class="o">=</span>hdfs
<span class="nb">export </span><span class="nv">HADOOP_SECURE_DN_PID_DIR</span><span class="o">=</span>/var/run/hadoop-hdfs
<span class="nb">export </span><span class="nv">HADOOP_SECURE_DN_LOG_DIR</span><span class="o">=</span>/var/log/hadoop-hdfs

<span class="nb">export </span><span class="nv">JSVC_HOME</span><span class="o">=</span>/usr/lib/bigtop-utils
</code></pre></div>
<p>将该文件同步到其他节点：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>scp /etc/default/hadoop-hdfs-datanode cdh2:/etc/default/hadoop-hdfs-datanode
<span class="nv">$ </span>scp /etc/default/hadoop-hdfs-datanode cdh3:/etc/default/hadoop-hdfs-datanode
</code></pre></div>
<p>分别在 cdh2、cdh3 获取 ticket 然后启动服务：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#root 为 root/admin 的密码</span>
<span class="nv">$ </span>ssh cdh1 <span class="s2">&quot;kinit -k -t /etc/hadoop/conf/hdfs.keytab hdfs/cdh1@JAVACHEN.COM; service hadoop-hdfs-datanode start&quot;</span>
<span class="nv">$ </span>ssh cdh2 <span class="s2">&quot;kinit -k -t /etc/hadoop/conf/hdfs.keytab hdfs/cdh2@JAVACHEN.COM; service hadoop-hdfs-datanode start&quot;</span>
<span class="nv">$ </span>ssh cdh3 <span class="s2">&quot;kinit -k -t /etc/hadoop/conf/hdfs.keytab hdfs/cdh3@JAVACHEN.COM; service hadoop-hdfs-datanode start&quot;</span>
</code></pre></div>
<p>观看 cdh1 上 NameNode 日志，出现下面日志表示 DataNode 启动成功：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">14/11/04 17:21:41 INFO security.UserGroupInformation:
Login successful for user hdfs/cdh2@JAVACHEN.COM using keytab file /etc/hadoop/conf/hdfs.keytab
</code></pre></div>
<h1 id="11.-总结">11. 总结</h1>

<p>本文介绍了 CDH Hadoop 集成 kerberos 认证的过程，其中主要需要注意以下几点：</p>

<ul>
<li>1. 配置 hosts，<code class="prettyprint">hostname</code> 请使用小写</li>
<li>2. 确保 kerberos 客户端和服务端连通</li>
<li>3. 替换 JRE 自带的 JCE jar 包</li>
<li>4. 为 DataNode 设置运行用户并配置 <code class="prettyprint">JSVC_HOME</code></li>
<li>5. 启动服务前，先获取 ticket 再运行相关命令</li>
</ul>

<p>上面的过程比较繁琐，我总结了上面的过程并写了一些自动化的脚本方便快速安装、配置以及管理 kerberos，请参考<a href="/2014/11/25/quikstart-for-config-kerberos-ldap-and-sentry-in-hadoop.html">Hadoop集群部署权限总结</a>。</p>

<h1 id="12.-参考文章">12. 参考文章</h1>

<ul>
<li><a href="http://blog.cloudera.com/blog/2015/03/how-to-quickly-configure-kerberos-for-your-apache-hadoop-cluster/">How-to: Quickly Configure Kerberos for Your Apache Hadoop Cluster</a></li>
<li><a href="https://github.com/zouhc/MyHadoop/blob/master/doc/Hadoop%E7%9A%84kerberos%E7%9A%84%E5%AE%9E%E8%B7%B5%E9%83%A8%E7%BD%B2.md">Hadoop的kerberos的实践部署</a></li>
<li><a href="http://blog.chinaunix.net/uid-1838361-id-3243243.html">hadoop 添加kerberos认证</a></li>
<li><a href="http://blog.csdn.net/lalaguozhe/article/details/11570009">YARN &amp; HDFS2 安装和配置Kerberos</a></li>
<li><a href="http://blog.godatadriven.com/kerberos_kdc_install.html">Kerberos basics and installing a KDC</a></li>
<li><a href="http://www.wuzesheng.com/?p=2345">Hadoop, Hbase, Zookeeper安全实践</a></li>
</ul>

                    <br/>
                     <br/>
                    <div class="well">
                        原创文章，转载请注明： 转载自<a href="http://blog.javachen.com">JavaChen Blog</a>，作者：<a href="http://blog.javachen.com/about.html">Junez</a><br/>
                        本文链接地址：<a href="/2014/11/04/config-kerberos-in-cdh-hdfs.html">http://blog.javachen.com/2014/11/04/config-kerberos-in-cdh-hdfs.html</a><br/>
                        本文基于<a target="_blank" title="Creative Commons Attribution 2.5 China Mainland License" href="http://creativecommons.org/licenses/by/2.5/cn/">署名 2.5 中国大陆许可协议</a>发布，欢迎转载、演绎或用于商业目的，但是必须保留本文的署名和文章链接。
                        如您有任何疑问或者授权方面的协商，请邮件联系我</a>。
                    </div>
                    <div class="col-md-6">
                      <p class="text-success hidden-print"><i class="fa fa-external-link"></i> <i class="small"><a href="/2014/11/04/config-kerberos-in-cdh-hdfs.html">HDFS配置Kerberos认证</a></i></p>
                    </div>
                    <div class="col-md-6">
                       <p class="meta hidden-print pull-right">
                        
                            <i class="fa fa-folder-open"></i>
                            
                            <a class="btn btn-default btn-xs" href="/categories.html#hadoop">hadoop</a>
                          
                        
                        
                            <i class="fa fa-tags"></i>
                            
                            <a class="btn btn-default btn-xs" href="/tags.html#hadoop">hadoop</a>
                          
                            <a class="btn btn-default btn-xs" href="/tags.html#kerberos">kerberos</a>
                          
                            <a class="btn btn-default btn-xs" href="/tags.html#cdh">cdh</a>
                          
                        </p>
                    </div>
               </div><!--#post-text-->
          </div><!--#post-->
      </div> <!--#content-->

      <div id="post-comment" class="hidden-print">
      
<div id="comments">
  <div class="ds-thread" data-thread-key="/2014/11/04/config-kerberos-in-cdh-hdfs.html" data-url="http://blog.javachen.com/2014/11/04/config-kerberos-in-cdh-hdfs.html" data-title="HDFS配置Kerberos认证"></div>
</div>



      </div>


          </div>
          <a href="#" class="btn back-to-top btn-dark btn-fixed-bottom hidden-print"><i class="fa fa-chevron-up"></i></a>
      </div>
      <div id="footer">
          <div class="container hidden-print">
              <p class="text-center"><i class="fa fa-copyright"></i> 2015 JavaChen Blog. Theme designed by <a href="/about.html" target="_blank" title="">Junez</a> with <a href="https://github.com/mojombo/jekyll/">Jekyll</a>, <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://fortawesome.github.com/Font-Awesome/">Font Awesome</a>.
  	            
            <script type="text/javascript">
                var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                document.write(unescape("%3Cspan id='cnzz_stat_icon_1253501761'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253501761' type='text/javascript'%3E%3C/script%3E"));</script>
            
            
    </p>
          </div>
      </div>

      <script type="text/javascript" src="/static/contrib/jquery/jquery.min.js"></script>
      <script type="text/javascript" src="/static/contrib/bootstrap/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/contrib/qrcode/jquery.qrcode.min.js"></script>
      <script type="text/javascript" src="/static/contrib/showup/showup.js"></script>
      <script type="text/javascript" src="/static/js/core.js"></script>
      
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"javachen"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      

      <script type="text/javascript">
      $('#qr').qrcode({
          width: 128,
          height: 128,
          text: 'http://blog.javachen.com/2014/11/04/config-kerberos-in-cdh-hdfs.html'
      });
      </script>
  </body>
</html>
