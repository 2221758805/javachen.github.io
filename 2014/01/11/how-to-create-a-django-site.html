<!DOCTYPE html>
<html lang="zh-cn">
        <head>
      <meta charset="utf-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
      <title>如何创建一个Django网站 - JavaChen Blog</title>
      <meta name="author" content="Junez"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
      <link rel="canonical" href="http://blog.javachen.com/2014/01/11/how-to-create-a-django-site.html" />

      <link rel="stylesheet" href="/static/contrib/bootstrap/css/bootstrap.min.css" media="all" />
      <link rel="stylesheet" href="/static/css/style.css" media="all" />
      <link rel="stylesheet" href="/static/css/pygments.css" media="all" />
      <link rel="stylesheet" href="/static/contrib/font-awesome/css/font-awesome.min.css" media="all" />
      <link rel="stylesheet" type="text/css" href="/static/contrib/showup/showup.css" />

      <!-- atom & rss feed -->
      <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="JavaChen Blog RSS Feed" />
      <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="JavaChen Blog ATOM Feed" />

        <!-- fav and touch icons  -->
        <!-- Update these with your own images
        <link rel="shortcut icon" href="images/favicon.ico">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
        -->

      <meta name="renderer" content="webkit|ie-stand">
      <meta name="baidu-site-verification" content="3HAhaWRiyR" />
      <meta name="360-site-verification" content="9b7a87a1d52051c96644f0a9b8b79898" />
      <meta name="sogou_site_verification" content="ofwXWFdthV"/>
      <meta property="wb:webmaster" content="b6081b2b8ab84c60" />
    </head>

    <body>
      <!--[if lte IE 9]>
<div class="alert alert-warning">
  <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
  <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
</div>
<![endif]-->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">JavaChen Blog</a>
        </div>
        <div class="navbar-collapse collapse">
            <form id="search-form" class="form-group navbar-form navbar-right" role="search">
                  <div class="form-group">
                    <input type="text" name="q" value=""  id="query" class="form-control" placeholder="搜索" required autocomplete="off" ></input>
                    <input type="submit" class="btn btn-default" value=" Go" ></input>
                  </div>
              </form>
            <ul class="nav navbar-nav">
              <li><a href="/archive.html" title="Archive"><span class='fa fa-archive fa-2x'></span></a></li>
              <li><a href="/categories.html" title="Categories"><span class='fa fa-navicon fa-2x'></span></a></li>
              <li><a href="/tags.html" title="Tags"><span class='fa fa-tags fa-2x'></span></a></li>
              <li><a href="/about.html" title="About"><span class='fa fa-user fa-2x'></span></a></li>
              
              <li><a href="https://github.com/javachen" target="_blank" title="Github"><span class='fa fa-github fa-2x'></span></a></li>
              
              
              
              <li><a href="https://twitter.com/junezchen" target="_blank" title="twitter"><span class="fa fa-twitter fa-2x"></span></a></li>
              
              
              
              <li><a href="http://weibo.com/chenzhijun" target="_blank" title="Weibo"><span class="fa fa-weibo fa-2x"></span></a></li>
              
              <li><a href="/rss.xml" target="_blank" title="RSS"><span class='fa fa-rss fa-2x'></span></a></li>
            </ul>
        </div>

        </div><!--/.nav-collapse -->
      </div>
</div>

      <div id="wrap">
          <div class="container">
                 <div id="content">
          <ul class="pager hidden-print">
               
                <li class="previous"><a href="/2014/01/09/after-reinstall-the-system.html" title="重装Linux-Mint系统之后"><i class="fa fa-angle-double-left"></i>&nbsp;重装Linux-Mint系统之后</a></li>
                
                
                <li class="next"><a href="/2014/01/13/about-sitemesh.html" title="SiteMesh介绍">SiteMesh介绍&nbsp;<i class="fa fa-angle-double-right"></i></a></li>
                
          </ul>

           <div id="post" class="clearfix">
              <div id="post-title" class="page-header text-center">
                  <h1> 如何创建一个Django网站  </h1>
              </div>
              <p class="text-muted clearfix">
                  <span class="pull-right">2014.01.11 | <a href="#comments">Comments</a></span>
              </p>
              <div id="qr" class="qrcode visible-lg"></div>

              <div id="post-text">
                    <p>本文参考<a href="https://docs.djangoproject.com/en/1.7/intro/">官方文档</a>演示如何创建一个简单的 django 网站，使用的 django 版本为1.7。</p>

<h1 id="1.-创建项目">1. 创建项目</h1>

<p>运行下面命令就可以创建一个 django 项目，项目名称叫 mysite ：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>django-admin.py startproject mysite
</code></pre></div>
<p>创建后的项目目录如下：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">mysite
├── manage.py
└── mysite
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py

1 directory, 5 files
</code></pre></div>
<p>说明：</p>

<ul>
<li><code class="prettyprint">__init__.py</code> ：让 Python 把该目录当成一个开发包 (即一组模块)所需的文件。 这是一个空文件，一般你不需要修改它。</li>
<li><code class="prettyprint">manage.py</code> ：一种命令行工具，允许你以多种方式与该 Django 项目进行交互。 键入<code class="prettyprint">python manage.py help</code>，看一下它能做什么。 你应当不需要编辑这个文件；在这个目录下生成它纯是为了方便。</li>
<li><code class="prettyprint">settings.py</code> ：该 Django 项目的设置或配置。</li>
<li><code class="prettyprint">urls.py</code>：Django项目的URL路由设置。目前，它是空的。</li>
<li><code class="prettyprint">wsgi.py</code>：WSGI web 应用服务器的配置文件。更多细节，查看 <a href="https://docs.djangoproject.com/en/1.7/howto/deployment/wsgi/">How to deploy with WSGI</a></li>
</ul>

<p>接下来，你可以修改 settings.py 文件，例如：修改 <code class="prettyprint">LANGUAGE_CODE</code>、设置时区 <code class="prettyprint">TIME_ZONE</code></p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">SITE_ID</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">&#39;zh_CN&#39;</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">&#39;Asia/Shanghai&#39;</span>

<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span> 
</code></pre></div>
<p>上面开启了 <a href="https://docs.djangoproject.com/en/1.7/topics/i18n/timezones/">Time zone</a> 特性，需要安装 pytz：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sudo pip install pytz
</code></pre></div>
<h1 id="2.-运行项目">2. 运行项目</h1>

<p>在运行项目之前，我们需要创建数据库和表结构，这里我使用的默认数据库：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py migrate
Operations to perform:
  Apply all migrations: admin, contenttypes, auth, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying sessions.0001_initial... OK
</code></pre></div>
<p>然后启动服务：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py runserver
</code></pre></div>
<p>你会看到下面的输出：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Performing system checks...

System check identified no issues (0 silenced).
January 28, 2015 - 02:08:33
Django version 1.7.1, using settings &#39;mysite.settings&#39;
Starting development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</code></pre></div>
<p>这将会在端口8000启动一个本地服务器, 并且只能从你的这台电脑连接和访问。 既然服务器已经运行起来了，现在用网页浏览器访问 <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>。你应该可以看到一个令人赏心悦目的淡蓝色 Django 欢迎页面它开始工作了。</p>

<p>你也可以指定启动端口:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py runserver 8080
</code></pre></div>
<p>以及指定 ip：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py runserver 0.0.0.0:8000
</code></pre></div>
<h1 id="3.-创建-app">3. 创建 app</h1>

<p>前面创建了一个项目并且成功运行，现在来创建一个 app，一个 app 相当于项目的一个子模块。</p>

<p>在项目目录下创建一个 app：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py startapp polls
</code></pre></div>
<p>如果操作成功，你会在 mysite 文件夹下看到已经多了一个叫 polls 的文件夹，目录结构如下：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">polls
├── __init__.py
├── admin.py
├── migrations
│   └── __init__.py
├── models.py
├── tests.py
└── views.py

1 directory, 6 files
</code></pre></div>
<h1 id="4.-创建模型">4. 创建模型</h1>

<ul>
<li>每一个 Django Model 都继承自 django.db.models.Model</li>
<li>在 Model 当中每一个属性 attribute 都代表一个 database field</li>
<li>通过 Django Model API 可以执行数据库的增删改查, 而不需要写一些数据库的查询语句</li>
</ul>

<p>打开 polls 文件夹下的 models.py 文件。创建两个模型：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s">&#39;date published&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_published_recently</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">&gt;=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Choice</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Question</span><span class="p">)</span>
    <span class="n">choice_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">votes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>然后在 mysite/settings.py 中修改 <code class="prettyprint">INSTALLED_APPS</code> 添加 polls：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s">&#39;polls&#39;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>在添加了新的 app 之后，我们需要运行下面命令告诉 Django 你的模型做了改变，需要迁移数据库：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py makemigrations polls
</code></pre></div>
<p>你会看到下面的输出日志：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">Migrations <span class="k">for</span> <span class="s1">&#39;polls&#39;</span>:
  0001_initial.py:
    - Create model Choice
    - Create model Question
    - Add field question to choice
</code></pre></div>
<p>你可以从 polls/migrations/0001_initial.py 查看迁移语句。</p>

<p>运行下面语句，你可以查看迁移的 sql 语句：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py sqlmigrate polls 0001
</code></pre></div>
<p>输出结果：</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">BEGIN</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">&quot;polls_choice&quot;</span> <span class="p">(</span><span class="ss">&quot;id&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span> <span class="ss">&quot;choice_text&quot;</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="ss">&quot;votes&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">&quot;polls_question&quot;</span> <span class="p">(</span><span class="ss">&quot;id&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span> <span class="ss">&quot;question_text&quot;</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="ss">&quot;pub_date&quot;</span> <span class="n">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">&quot;polls_choice__new&quot;</span> <span class="p">(</span><span class="ss">&quot;id&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span> <span class="ss">&quot;choice_text&quot;</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="ss">&quot;votes&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="ss">&quot;question_id&quot;</span> <span class="nb">integer</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="ss">&quot;polls_question&quot;</span> <span class="p">(</span><span class="ss">&quot;id&quot;</span><span class="p">));</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;polls_choice__new&quot;</span> <span class="p">(</span><span class="ss">&quot;choice_text&quot;</span><span class="p">,</span> <span class="ss">&quot;votes&quot;</span><span class="p">,</span> <span class="ss">&quot;id&quot;</span><span class="p">)</span> <span class="k">SELECT</span> <span class="ss">&quot;choice_text&quot;</span><span class="p">,</span> <span class="ss">&quot;votes&quot;</span><span class="p">,</span> <span class="ss">&quot;id&quot;</span> <span class="k">FROM</span> <span class="ss">&quot;polls_choice&quot;</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="ss">&quot;polls_choice&quot;</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="ss">&quot;polls_choice__new&quot;</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="ss">&quot;polls_choice&quot;</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">polls_choice_7aa0f6ee</span> <span class="k">ON</span> <span class="ss">&quot;polls_choice&quot;</span> <span class="p">(</span><span class="ss">&quot;question_id&quot;</span><span class="p">);</span>

<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>
<p>你可以运行下面命令，来检查数据库是否有问题：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py check
</code></pre></div>
<p>再次运行下面的命令，来创建新添加的模型：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py migrate
Operations to perform:
  Apply all migrations: admin, contenttypes, polls, auth, sessions
Running migrations:
  Applying polls.0001_initial... OK
</code></pre></div>
<p>总结一下，当修改一个模型时，需要做以下几个步骤：</p>

<ul>
<li>修改 models.py 文件</li>
<li>运行 <code class="prettyprint">python manage.py makemigrations</code> 创建迁移语句</li>
<li>运行 <code class="prettyprint">python manage.py migrate</code>，将模型的改变迁移到数据库中</li>
</ul>

<p>你可以阅读 <a href="https://docs.djangoproject.com/en/1.7/ref/django-admin/">django-admin.py documentation</a>，查看更多 manage.py 的用法。</p>

<p>创建了模型之后，我们可以通过 Django 提供的 API 来做测试。运行下面命令可以进入到 python shell 的交互模式：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py shell
</code></pre></div>
<p>下面是一些测试：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span><span class="p">,</span> <span class="n">Choice</span>   <span class="c"># Import the model classes we just wrote.</span>

<span class="c"># No questions are in the system yet.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[]</span>

<span class="c"># Create a new Question.</span>
<span class="c"># Support for time zones is enabled in the default settings file, so</span>
<span class="c"># Django expects a datetime with tzinfo for pub_date. Use timezone.now()</span>
<span class="c"># instead of datetime.datetime.now() and it will do the right thing.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Question</span><span class="p">(</span><span class="n">question_text</span><span class="o">=</span><span class="s">&quot;What&#39;s new?&quot;</span><span class="p">,</span> <span class="n">pub_date</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

<span class="c"># Save the object into the database. You have to call save() explicitly.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c"># Now it has an ID. Note that this might say &quot;1L&quot; instead of &quot;1&quot;, depending</span>
<span class="c"># on which database you&#39;re using. That&#39;s no biggie; it just means your</span>
<span class="c"># database backend prefers to return integers as Python long integer</span>
<span class="c"># objects.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">id</span>
<span class="mi">1</span>

<span class="c"># Access model field values via Python attributes.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">question_text</span>
<span class="s">&quot;What&#39;s new?&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">pub_date</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">775217</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=&lt;</span><span class="n">UTC</span><span class="o">&gt;</span><span class="p">)</span>

<span class="c"># Change values by changing the attributes, then calling save().</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">question_text</span> <span class="o">=</span> <span class="s">&quot;What&#39;s up?&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c"># objects.all() displays all the questions in the database.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Question</span><span class="p">:</span> <span class="n">Question</span> <span class="nb">object</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div>
<p>打印所有的 Question 时，输出的结果是 <code class="prettyprint">[&lt;Question: Question object&gt;]</code>，我们可以修改模型类，使其输出更为易懂的描述。修改模型类：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">from django.db import models

class Question(models.Model):
    # ...
    def __str__(self):              # __unicode__ on Python 2
        return self.question_text

class Choice(models.Model):
    # ...
    def __str__(self):              # __unicode__ on Python 2
        return self.choice_text
</code></pre></div>
<p>接下来继续测试：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">&gt;&gt;&gt; from polls.models import Question, Choice

<span class="c"># Make sure our __str__() addition worked.</span>
&gt;&gt;&gt; Question.objects.all<span class="o">()</span>
<span class="o">[</span>&lt;Question: What<span class="s1">&#39;s up?&gt;]</span>

<span class="s1"># Django provides a rich database lookup API that&#39;</span>s entirely driven by
<span class="c"># keyword arguments.</span>
&gt;&gt;&gt; Question.objects.filter<span class="o">(</span><span class="nv">id</span><span class="o">=</span>1<span class="o">)</span>
<span class="o">[</span>&lt;Question: What<span class="s1">&#39;s up?&gt;]</span>
<span class="s1">&gt;&gt;&gt; Question.objects.filter(question_text__startswith=&#39;</span>What<span class="s1">&#39;)</span>
<span class="s1">[&lt;Question: What&#39;</span>s up?&gt;<span class="o">]</span>

<span class="c"># Get the question that was published this year.</span>
&gt;&gt;&gt; from django.utils import timezone
&gt;&gt;&gt; <span class="nv">current_year</span> <span class="o">=</span> timezone.now<span class="o">()</span>.year
&gt;&gt;&gt; Question.objects.get<span class="o">(</span><span class="nv">pub_date__year</span><span class="o">=</span>current_year<span class="o">)</span>
&lt;Question: What<span class="s1">&#39;s up?&gt;</span>

<span class="s1"># Request an ID that doesn&#39;</span>t exist, this will raise an exception.
&gt;&gt;&gt; Question.objects.get<span class="o">(</span><span class="nv">id</span><span class="o">=</span>2<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
    ...
DoesNotExist: Question matching query does not exist.

<span class="c"># Lookup by a primary key is the most common case, so Django provides a</span>
<span class="c"># shortcut for primary-key exact lookups.</span>
<span class="c"># The following is identical to Question.objects.get(id=1).</span>
&gt;&gt;&gt; Question.objects.get<span class="o">(</span><span class="nv">pk</span><span class="o">=</span>1<span class="o">)</span>
&lt;Question: What<span class="s1">&#39;s up?&gt;</span>

<span class="s1"># Make sure our custom method worked.</span>
<span class="s1">&gt;&gt;&gt; q = Question.objects.get(pk=1)</span>

<span class="s1"># Give the Question a couple of Choices. The create call constructs a new</span>
<span class="s1"># Choice object, does the INSERT statement, adds the choice to the set</span>
<span class="s1"># of available choices and returns the new Choice object. Django creates</span>
<span class="s1"># a set to hold the &quot;other side&quot; of a ForeignKey relation</span>
<span class="s1"># (e.g. a question&#39;</span>s choice<span class="o">)</span> which can be accessed via the API.
&gt;&gt;&gt; <span class="nv">q</span> <span class="o">=</span> Question.objects.get<span class="o">(</span><span class="nv">pk</span><span class="o">=</span>1<span class="o">)</span>

<span class="c"># Display any choices from the related object set -- none so far.</span>
&gt;&gt;&gt; q.choice_set.all<span class="o">()</span>
<span class="o">[]</span>

<span class="c"># Create three choices.</span>
&gt;&gt;&gt; q.choice_set.create<span class="o">(</span><span class="nv">choice_text</span><span class="o">=</span><span class="s1">&#39;Not much&#39;</span>, <span class="nv">votes</span><span class="o">=</span>0<span class="o">)</span>
&lt;Choice: Not much&gt;
&gt;&gt;&gt; q.choice_set.create<span class="o">(</span><span class="nv">choice_text</span><span class="o">=</span><span class="s1">&#39;The sky&#39;</span>, <span class="nv">votes</span><span class="o">=</span>0<span class="o">)</span>
&lt;Choice: The sky&gt;
&gt;&gt;&gt; <span class="nv">c</span> <span class="o">=</span> q.choice_set.create<span class="o">(</span><span class="nv">choice_text</span><span class="o">=</span><span class="s1">&#39;Just hacking again&#39;</span>, <span class="nv">votes</span><span class="o">=</span>0<span class="o">)</span>

<span class="c"># Choice objects have API access to their related Question objects.</span>
&gt;&gt;&gt; c.question
&lt;Question: What<span class="s1">&#39;s up?&gt;</span>

<span class="s1"># And vice versa: Question objects get access to Choice objects.</span>
<span class="s1">&gt;&gt;&gt; q.choice_set.all()</span>
<span class="s1">[&lt;Choice: Not much&gt;, &lt;Choice: The sky&gt;, &lt;Choice: Just hacking again&gt;]</span>
<span class="s1">&gt;&gt;&gt; q.choice_set.count()</span>
<span class="s1">3</span>

<span class="s1"># The API automatically follows relationships as far as you need.</span>
<span class="s1"># Use double underscores to separate relationships.</span>
<span class="s1"># This works as many levels deep as you want; there&#39;</span>s no limit.
<span class="c"># Find all Choices for any question whose pub_date is in this year</span>
<span class="c"># (reusing the &#39;current_year&#39; variable we created above).</span>
&gt;&gt;&gt; Choice.objects.filter<span class="o">(</span><span class="nv">question__pub_date__year</span><span class="o">=</span>current_year<span class="o">)</span>
<span class="o">[</span>&lt;Choice: Not much&gt;, &lt;Choice: The sky&gt;, &lt;Choice: Just hacking again&gt;<span class="o">]</span>

<span class="c"># Let&#39;s delete one of the choices. Use delete() for that.</span>
&gt;&gt;&gt; <span class="nv">c</span> <span class="o">=</span> q.choice_set.filter<span class="o">(</span><span class="nv">choice_text__startswith</span><span class="o">=</span><span class="s1">&#39;Just hacking&#39;</span><span class="o">)</span>
&gt;&gt;&gt; c.delete<span class="o">()</span>
&gt;&gt;&gt; 
</code></pre></div>
<p>上面这部分测试，涉及到  django orm 相关的知识，详细说明可以参考 <a href="/2015/01/15/django-orm.html">Django中的ORM</a>。</p>

<h1 id="5.-管理-admin">5. 管理 admin</h1>

<p>Django有一个优秀的特性, 内置了Django admin后台管理界面, 方便管理者进行添加和删除网站的内容.</p>

<p>新建的项目系统已经为我们设置好了后台管理功能，见 mysite/settings.py：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span> <span class="c">#默认添加后台管理功能</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s">&#39;polls&#39;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>同时也已经添加了进入后台管理的 url, 可以在  mysite/urls.py 中查看：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span> <span class="c">#可以使用设置好的url进入网站后台</span>
</code></pre></div>
<p>接下来我们需要创建一个管理用户来登录 admin 后台管理界面：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ python manage.py createsuperuser
Username (leave blank to use &#39;june&#39;): admin
Email address:
Password:
Password (again):
Superuser created successfully.
</code></pre></div>
<p>上面创建了一个 admin 的超级用户，密码也为 admin。</p>

<p>再次运行项目：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python manage.py runserver
</code></pre></div>
<p>然后，访问web 页面 <a href="http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a>，你将会看到：</p>

<p><img src="https://docs.djangoproject.com/en/1.7/_images/admin01.png" alt=""></p>

<p>输入用户名和密码，你可以看到：</p>

<p><img src="https://docs.djangoproject.com/en/1.7/_images/admin02.png" alt=""></p>

<p>这时候你可以看到，你可以修改 groups 和 users 两个对象，但是你不能修改你添加的模型。下面来使你添加的模型也能修改，修改 polls/admin.py：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>

<span class="k">class</span> <span class="nc">ChoiceInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">StackedInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Choice</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">class</span> <span class="nc">QuestionAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fieldsets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="bp">None</span><span class="p">,</span>               <span class="p">{</span><span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;question_text&#39;</span><span class="p">]}),</span>
        <span class="p">(</span><span class="s">&#39;Date information&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;pub_date&#39;</span><span class="p">],</span> <span class="s">&#39;classes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;collapse&#39;</span><span class="p">]}),</span>
    <span class="p">]</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ChoiceInline</span><span class="p">]</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;pub_date&#39;</span><span class="p">]</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;question_text&#39;</span><span class="p">,</span> <span class="s">&#39;pub_date&#39;</span><span class="p">,</span> <span class="s">&#39;was_published_recently&#39;</span><span class="p">)</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Choice</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">QuestionAdmin</span><span class="p">)</span>
</code></pre></div>
<p>你单击表头时，会发现 was_published_recently 这一列无法排序，我们可以修改  polls/models.py 中的 Question 模型，额外添加一些属性：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Question</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">was_published_recently</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">&gt;=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">was_published_recently</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s">&#39;pub_date&#39;</span>
    <span class="n">was_published_recently</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">was_published_recently</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s">&#39;Published recently?&#39;</span>
</code></pre></div>
<h2 id="定制外观">定制外观</h2>

<p>在项目根路径创建一个 templates 目录，并修改 mysite/settings.py 文件，添加下面设置：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)]</span>
</code></pre></div>
<p>在 templates  下面创建一个 admin 目录，并从 Django admin 模板路径下拷贝 admin/base_site.html 文件到 admin 目录下，修改该文件：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">{% block branding %}
<span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">&quot;site-name&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{% url &#39;admin:index&#39; %}&quot;</span><span class="nt">&gt;</span>Polls Administration<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
{% endblock %}</code></pre></div>

<p>同样，你可以参考上面定制 admin/index.html 内容。</p>

<h2 id="使用第三方插件">使用第三方插件</h2>

<p>Django现在已经相对成熟，已经有许多不错的可以使用的第三方插件可以使用，这些插件各种各样，现在我们使用一个第三方插件使后台管理界面更加美观，目前大部分第三方插件可以在 <a href="https://www.djangopackages.com/">Django Packages</a> 中查看，尝试使用 <a href="https://github.com/douglasmiranda/django-admin-bootstrap">django-admin-bootstrap</a> 美化后台管理界面。</p>

<p>安装：</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip install bootstrap-admin
</code></pre></div>
<p>然后在 mysite/settings.py 中修改 INSTALLED_APPS：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;bootstrap_admin&#39;</span><span class="p">,</span>  <span class="c">#一定要放在`django.contrib.admin`前面</span>
    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s">&#39;polls&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">global_settings</span>
<span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">=</span> <span class="n">global_settings</span><span class="o">.</span><span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">+</span> <span class="p">(</span>
    <span class="s">&#39;django.core.context_processors.request&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">BOOTSTRAP_ADMIN_SIDEBAR_MENU</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div>
<p>保存后，再次刷新页面，访问 <a href="http://127.0.0.1:8000/admin">http://127.0.0.1:8000/admin</a>。</p>

<h1 id="6.-视图和url配置">6. 视图和URL配置</h1>

<p>Django 中 views 里面的代码就是一个一个函数逻辑，处理客户端(浏览器)发送的 HTTPRequest，然后返回 HTTPResponse。</p>

<h2 id="第一个视图">第一个视图</h2>

<p>创建 <code class="prettyprint">polls/views.py</code> 文件并添加如下内容：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Hello, world. You&#39;re at the polls index.&quot;</span><span class="p">)</span>
</code></pre></div>
<p>在 <code class="prettyprint">polls/urls.py</code> 中添加一个 url 映射：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">polls</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>这时候 polls 目录结构如下：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">polls
├── __init__.py
├── admin.py
├── migrations
│   ├── 0001_initial.py
│   ├── __init__.py
├── models.py
├── tests.py
├── urls.py
└── views.py
</code></pre></div>
<p>在上面视图文件中，我们只是告诉 Django，所有指向 URL <code class="prettyprint">/index/</code> 的请求都应由 index 这个视图函数来处理。</p>

<p>Django 在检查 URL 模式前，移除每一个申请的URL开头的斜杠。 这意味着我们为 <code class="prettyprint">/index/</code> 写URL模式不用包含斜杠。</p>

<p>模式包含了一个尖号(<code class="prettyprint">^</code>)和一个美元符号(<code class="prettyprint">$</code>)。这些都是正则表达式符号，并且有特定的含义： <sup>要求表达式对字符串的头部进行匹配，$符号则要求表达式对字符串的尾部进行匹配。</sup></p>

<p>如果你访问 <code class="prettyprint">/index</code>，默认会重定向到末尾带有反斜杠的请求上去，这是受配置文件setting中 <code class="prettyprint">APPEND_SLASH</code> 项控制的。</p>

<p>如果你是喜欢所有URL都以 <code class="prettyprint">/</code> 结尾的人（Django开发者的偏爱），那么你只需要在每个 URL 后添加斜杠，并且设置 <code class="prettyprint">APPEND_SLASH</code> 为 &quot;True&quot;。如果不喜欢URL以斜杠结尾或者根据每个 URL 来决定，那么需要设置 <code class="prettyprint">APPEND_SLASH</code> 为 &quot;False&quot;，并且根据你自己的意愿来添加结尾斜杠/在URL模式后。</p>

<p>接下来配置项目根路径的 URL 映射，修改  mysite/urls.py 如下：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^polls/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;polls.urls&#39;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</code></pre></div>
<p>打开浏览器，访问 <a href="http://localhost:8000/polls/">http://localhost:8000/polls/</a>，你将会看到 <code class="prettyprint">Hello, world. You’re at the polls index.</code>。</p>

<h2 id="编写更多视图">编写更多视图</h2>

<p>修改  polls/views.py 文件，添加：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;You&#39;re looking at question </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">question_id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;You&#39;re looking at the results of question </span><span class="si">%s</span><span class="s">.&quot;</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">response</span> <span class="o">%</span> <span class="n">question_id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;You&#39;re voting on question </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">question_id</span><span class="p">)</span>
</code></pre></div>
<p>然后，修改 polls/urls.py 添加映射：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">polls</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="c"># ex: /polls/</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
    <span class="c"># ex: /polls/5/</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;question_id&gt;\d+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;detail&#39;</span><span class="p">),</span>
    <span class="c"># ex: /polls/5/results/</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;question_id&gt;\d+)/results/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;results&#39;</span><span class="p">),</span>
    <span class="c"># ex: /polls/5/vote/</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;question_id&gt;\d+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="正则表达式">正则表达式</h2>

<p>正则表达式是通用的文本模式匹配的方法。 Django URLconfs 允许你使用任意的正则表达式来做强有力的 URL 映射，不过通常你实际上可能只需要使用很少的一部分功能。这里是一些基本的语法。</p>

<table><thead>
<tr>
<th style="text-align: left">符号</th>
<th style="text-align: left">匹配</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">.</td>
<td style="text-align: left">任意单一字符</td>
</tr>
<tr>
<td style="text-align: left">\d</td>
<td style="text-align: left">任意一位数字</td>
</tr>
<tr>
<td style="text-align: left">[A-Z]</td>
<td style="text-align: left">A 到 Z中任意一个字符（大写）</td>
</tr>
<tr>
<td style="text-align: left">[a-z]</td>
<td style="text-align: left">a 到 z中任意一个字符（小写）</td>
</tr>
<tr>
<td style="text-align: left">[A-Za-z]</td>
<td style="text-align: left">a 到 z中任意一个字符（不区分大小写）</td>
</tr>
<tr>
<td style="text-align: left">+</td>
<td style="text-align: left">匹配一个或更多 (例如, \d+ 匹配一个或 多个数字字符)</td>
</tr>
<tr>
<td style="text-align: left">[<sup>/]+</sup></td>
<td style="text-align: left">一个或多个不为‘/’的字符</td>
</tr>
<tr>
<td style="text-align: left">*</td>
<td style="text-align: left">零个或一个之前的表达式（例如：\d? 匹配零个或一个数字）</td>
</tr>
<tr>
<td style="text-align: left">*</td>
<td style="text-align: left">匹配0个或更多 (例如, \d* 匹配0个 或更多数字字符)</td>
</tr>
<tr>
<td style="text-align: left">{1,3}</td>
<td style="text-align: left">介于一个和三个（包含）之前的表达式（例如，\d{1,3}匹配一个或两个或三个数字）</td>
</tr>
</tbody></table>

<p>有关正则表达式的更多内容，请访问<a href="http://www.djangoproject.com/r/python/re-module/">http://www.djangoproject.com/r/python/re-module/</a></p>

<h2 id="动态内容">动态内容</h2>

<p>接下来使视图返回动态内容，修改 mysite/views.py 内容如下：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">latest_question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">question_text</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">latest_question_list</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="c"># Leave the rest of the views (detail, results, vote) unchanged</span>
</code></pre></div>
<p>这时候访问 <a href="http://127.0.0.1:8000/polls/">http://127.0.0.1:8000/polls/</a> 可以看到输出内容为所有的问题通过逗号连接。</p>

<h2 id="使用模板">使用模板</h2>

<p>接下来在视图中使用模板，在 settings.py 中有一个 <code class="prettyprint">TEMPLATE_LOADERS</code> 属性，并且有一个默认值  <code class="prettyprint">django.template.loaders.app_directories.Loader</code>，该值定义了从每一个安装的 app 的 templates 目录下寻找模板，故我们可以在 polls 目录下创建 templates 目录以及其子目录 polls。</p>

<p>现在创建一个首页页面  polls/templates/polls/index.html：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">{% if latest_question_list %}
    <span class="nt">&lt;ul&gt;</span>
    {% for question in latest_question_list %}
        <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/polls/{{ question.id }}/&quot;</span><span class="nt">&gt;</span>{{ question.question_text }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    {% endfor %}
    <span class="nt">&lt;/ul&gt;</span>
{% else %}
    <span class="nt">&lt;p&gt;</span>No polls are available.<span class="nt">&lt;/p&gt;</span>
{% endif %}</code></pre></div>

<blockquote>
<p>注意：<br>
页面中的 latest_question_list 变量来自视图返回的上下文，见下面 context 变量</p>
</blockquote>

<p>然后更新 polls/views.py 视图，来使用模板：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span><span class="p">,</span> <span class="n">loader</span>

<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">latest_question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;polls/index.html&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;latest_question_list&#39;</span><span class="p">:</span> <span class="n">latest_question_list</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
</code></pre></div>
<p>代码说明：</p>

<ul>
<li>通过 loader 来加载模板页面，如前面提到的，这里是相对 polls/templates 目录</li>
<li>创建上下文，将需要传递到页面的变量放入上下文变量 context</li>
<li>使用 template 通过上下文来渲染页面</li>
</ul>

<p>上面代码，可以使用  <code class="prettyprint">render()</code> 来简化：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">latest_question_list</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;latest_question_list&#39;</span><span class="p">:</span> <span class="n">latest_question_list</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/index.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div>
<p>当查询数据返回错误时，可以抛出异常，让页面重定向到 404 页面：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span>
<span class="c"># ...</span>
<span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Question</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s">&quot;Question does not exist&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>
</code></pre></div>
<p>现在，我们可以回过头来修改  polls/index.html 页面中下面代码：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/polls/{{ question.id }}/&quot;</span><span class="nt">&gt;</span>{{ question.question_text }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span></code></pre></div>

<p>上面代码中的 url 为硬编码的，我们可以将其修改为：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{ % url  &#39;detail&#39; question.id  %}&quot;</span><span class="nt">&gt;</span>{{ question.question_text }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span></code></pre></div>

<p>为了避免多个视图的名称，例如 detail 视图，的冲突，我们可以给 URL 添加命名空间，修改 mysite/urls.py：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^polls/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;polls.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&quot;polls&quot;</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</code></pre></div>
<p>然后，修改 polls/templates/polls/index.html 为：</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{ % url &#39;polls:detail&#39; question.id % }&quot;</span><span class="nt">&gt;</span>{{ question.question_text }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span></code></pre></div>

<p>接下来创建明细页面 polls/templates/polls/detail.html：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;h1&gt;</span>{{ question.question_text }}<span class="nt">&lt;/h1&gt;</span>

{% if error_message %}<span class="nt">&lt;p&gt;&lt;strong&gt;</span>{{ error_message }}<span class="nt">&lt;/strong&gt;&lt;/p&gt;</span>{% endif %}

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;{% url &#39;polls:vote&#39; question.id %}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
{% csrf_token %}
{% for choice in question.choice_set.all %}
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;choice&quot;</span> <span class="na">id=</span><span class="s">&quot;choice{{ forloop.counter }}&quot;</span> <span class="na">value=</span><span class="s">&quot;{{ choice.id }}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;choice{{ forloop.counter }}&quot;</span><span class="nt">&gt;</span>{{ choice.choice_text }}<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
{% endfor %}
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Vote&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></div>

<p>创建一个显示投票结果页面 polls/templates/polls/results.html ：</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;h1&gt;</span>{{ question.question_text }}<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
{% for choice in question.choice_set.all %}
    <span class="nt">&lt;li&gt;</span>{{ choice.choice_text }} -- {{ choice.votes }} vote{{ choice.votes|pluralize }}<span class="nt">&lt;/li&gt;</span>
{% endfor %}
<span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{% url &#39;polls:detail&#39; question.id %}&quot;</span><span class="nt">&gt;</span>Vote again?<span class="nt">&lt;/a&gt;</span></code></pre></div>

<p>接下来修改 polls/views.py 添加 detail 、 vote 和 results 三个函数：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Question</span><span class="p">,</span><span class="n">Choice</span>

<span class="c"># ...</span>
<span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c"># Redisplay the question voting form.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;question&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
            <span class="s">&#39;error_message&#39;</span><span class="p">:</span> <span class="s">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>    

<span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>        
</code></pre></div>
<p>重启服务进行测试，检查是否有错误。</p>

<h2 id="简化代码">简化代码</h2>

<p>如果我们要针对很多模型编写视图，则有很多代码都是重复的，我们可以使用 Django 中的通用视图来简化代码。首先，我们将  polls/urls.py 改成如下：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">polls</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;pk&gt;\d+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;pk&gt;\d+)/results/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ResultsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;results&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;question_id&gt;\d+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>然后，我们删除 polls/views.py 中的 index、detail 和 results 三个函数，vote 函数和之前保持一致，最后改为如下：</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">generic</span>

<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="k">class</span> <span class="nc">IndexView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;polls/index.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s">&#39;latest_question_list&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the last five published questions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;polls/detail.html&#39;</span>


<span class="k">class</span> <span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;polls/results.html&#39;</span>


<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="o">...</span> <span class="c"># same as above</span>
</code></pre></div>
<p>代码说明：</p>

<ul>
<li>这里我们使用了两个通用视图 : ListView 和 DetailView，来和模型相关联。</li>
<li>DetailView 视图需要传递一个名称为 pk 表示模型主键的参数，所以我们需要把 URL 映射中的 question_id  改为 pk。</li>
<li>默认情况下， DetailView使用  <code class="prettyprint">&lt;app name&gt;/&lt;model name&gt;_detail.html</code> 模板，我们可以使用 <code class="prettyprint">template_name</code> 变量重新定义模板路径；类似的， ListView 默认使用 <code class="prettyprint">&lt;app name&gt;/&lt;model name&gt;_list.html</code> 模板。</li>
<li>DetailView 视图中的上下文默认就包含了对模型的引用，如 question 变量；对于 ListView 视图，为 question_list 变量，如果我们想修改该变量名称，可以通过 <code class="prettyprint">context_object_name 变量覆盖默认的名称</code>，如使用 latest_question_list 代替 question_list。</li>
</ul>

<p>更多的文档，请参考 <a href="https://docs.djangoproject.com/en/1.7/topics/class-based-views/">generic views documentation</a>。</p>

<h1 id="7.-总结">7. 总结</h1>

<p>最后，来看项目目录结构：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">mysite
├── db.sqlite3
├── manage.py
├── mysite
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   ├── wsgi.py
├── polls
│   ├── __init__.py
│   ├── admin.py
│   ├── migrations
│   │   ├── 0001_initial.py
│   │   ├── __init__.py
│   ├── models.py
│   ├── templates
│   │   └── polls
│   │       ├── detail.html
│   │       ├── index.html
│   │       └── results.html
│   ├── tests.py
│   ├── urls.py
│   ├── views.py
└── templates
    └── admin
        └── base_site.htm      
</code></pre></div>
<p>通过上面的介绍，对 django 的安装、运行以及如何创建视图和模型有了一个清晰的认识，接下来就可以深入的学习 django 的自动化测试、持久化、中间件、国际化等知识。</p>

<h1 id="8.-参考文章">8. 参考文章</h1>

<ul>
<li><a href="https://docs.djangoproject.com/en/1.7/intro/">Django1.7官方文档</a></li>
<li><a href="http://markchen.me/django-instance-tutorial-blog-1/">django实例教程–blog(1)</a></li>
<li><a href="http://djangobook.py3k.cn/2.0/">The Django book 2.0</a></li>
<li><a href="http://andrew-liu.gitbooks.io/django-blog/content/">Django搭建简易博客</a></li>
</ul>

                    <br/>
                    <div class="well">
                        原创文章，转载请注明： 转载自<a href="http://blog.javachen.com">JavaChen Blog</a>，作者：<a href="http://blog.javachen.com/about.html">Junez</a><br/>
                        本文链接地址：<a href="/2014/01/11/how-to-create-a-django-site.html">http://blog.javachen.com/2014/01/11/how-to-create-a-django-site.html</a><br/>
                        本文基于<a target="_blank" title="Creative Commons Attribution 2.5 China Mainland License" href="http://creativecommons.org/licenses/by/2.5/cn/">署名2.5中国大陆许可协议</a>发布，欢迎转载、演绎或用于商业目的，但是必须保留本文署名和文章链接。
                        如您有任何疑问或者授权方面的协商，请邮件联系我</a>。
                    </div>
                    <div class="col-md-6">
                      <p class="text-success hidden-print"><i class="fa fa-external-link"></i> <a href="/2014/01/11/how-to-create-a-django-site.html">如何创建一个Django网站</a></p>
                    </div>
                    <div class="col-md-6">
                       <p class="meta hidden-print pull-right">
                        
                            <i class="fa fa-folder-open"></i>
                            
                            <a class="btn btn-default btn-sm" href="/categories.html#python">python</a>
                          
                        
                        
                            <i class="fa fa-tags"></i>
                            
                            <a class="btn btn-default btn-sm" href="/tags.html#python">python</a>
                          
                            <a class="btn btn-default btn-sm" href="/tags.html#django">django</a>
                          
                        </p>
                    </div>
               </div><!--#post-text-->
          </div><!--#post-->
      </div> <!--#content-->

      <div id="post-comment" class="hidden-print">
      
<div id="comments">
  <div class="ds-thread" data-thread-key="/2014/01/11/how-to-create-a-django-site.html" data-url="http://blog.javachen.com/2014/01/11/how-to-create-a-django-site.html" data-title="如何创建一个Django网站"></div>
</div>



      </div>


          </div>
          <a href="#" class="btn back-to-top btn-dark btn-fixed-bottom hidden-print"><i class="fa fa-chevron-up"></i></a>
      </div>
      <div id="footer">
          <div class="container hidden-print">
              <p class="text-center"><i class="fa fa-copyright"></i> 2015 JavaChen Blog. Theme designed by <a href="/about.html" target="_blank" title="">Junez</a> with <a href="https://github.com/mojombo/jekyll/">Jekyll</a>, <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://fortawesome.github.com/Font-Awesome/">Font Awesome</a>.
  	            
            <script type="text/javascript">
                var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                document.write(unescape("%3Cspan id='cnzz_stat_icon_1253501761'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253501761' type='text/javascript'%3E%3C/script%3E"));</script>
            
            
    </p>
          </div>
      </div>

      <script type="text/javascript" src="/static/contrib/jquery/jquery.min.js"></script>
      <script type="text/javascript" src="/static/contrib/bootstrap/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/contrib/qrcode/jquery.qrcode.min.js"></script>
      <script type="text/javascript" src="/static/contrib/showup/showup.js"></script>
      <script type="text/javascript" src="/static/js/core.js"></script>
      
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"javachen"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      

      <script type="text/javascript">
      $('#qr').qrcode({
          width: 128,
          height: 128,
          text: 'http://blog.javachen.com/2014/01/11/how-to-create-a-django-site.html'
      });
      </script>
  </body>
</html>
